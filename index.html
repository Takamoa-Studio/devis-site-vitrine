<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur de co√ªt - Site vitrine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #020617;
      --card: #020617;
      --card-soft: #0b1220;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --accent-2: #4ade80;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
      --shadow-chip: 0 10px 24px rgba(15, 23, 42, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d283a 0, #020617 45%, #000 100%);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    h1 {
      font-size: clamp(1.7rem, 3vw, 2.2rem);
    }

    h2 {
      font-size: 1.1rem;
      text-transform: uppercase;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .brand-logo-img {
      width: 180px;
      height: auto;
      display: block;
      filter: drop-shadow(0 10px 30px rgba(56, 189, 248, 0.35));
    }

    .brand-subtitle {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .pill {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: var(--accent);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-chip);
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 12px rgba(74, 222, 128, 0.9);
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }

      .sticky-summary {
        position: static;
      }
    }

    .column-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sticky-summary {
      position: sticky;
      top: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08) 0, rgba(15,23,42,0.95) 45%, #020617 100%);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(16px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card-header h2 {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card-header h2 span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--accent);
    }

    .card-header p.sub {
      font-size: 0.78rem;
      color: var(--muted);
      margin: 0;
      max-width: 220px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
    }

    .field-groups {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-group {
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.06), rgba(74, 222, 128, 0.04));
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .group-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .group-title {
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .group-title .icon {
      font-size: 0.8rem;
      color: var(--accent);
    }

    .group-sub {
      margin: 0;
      font-size: 0.78rem;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .field label {
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.8rem;
    }

    .field label span.hint {
      color: #6b7280;
      font-size: 0.75rem;
      text-align: end;
    }

    .field input[type="number"],
    .field input[type="text"],
    .field select {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px 10px;
      color: var(--text);
      outline: none;
      font-size: 0.82rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      width: 100%;
    }

    .field input[type="number"]:focus,
    .field input[type="text"]:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
      background: rgba(15, 23, 42, 1);
    }

    .field .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .field .control-row select {
      flex: 1 1 auto;
    }

    .ghost-button {
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--accent);
      border-radius: var(--radius-md);
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }

    .ghost-button:hover {
      background: rgba(56, 189, 248, 0.16);
      border-color: rgba(56, 189, 248, 0.5);
      color: #67e8f9;
    }

    .field input::placeholder {
      color: #4b5563;
    }

    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .field-row .title {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .field-row .value {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(56, 189, 248, 0.2);
      font-size: 0.7rem;
      color: var(--muted);
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-2);
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
    }

    .roles-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(56,189,248,0.1) 0, #020617 45%, #020617 100%);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 100%;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    th, td {
      padding: 7px 10px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: #9ca3af;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
    }

    tbody tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.95);
    }

    tbody tr:hover td {
      background: rgba(30, 64, 175, 0.45);
    }

    .roles-table input {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 8px;
      color: var(--text);
      font-size: 0.75rem;
      width: 70px;
      outline: none;
    }

    .roles-table input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    .summary-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      margin-top: 14px;
    }

    @media (max-width: 900px) {
      .summary-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .summary-card {
      padding: 12px 12px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(56, 189, 248, 0.25);
      background: linear-gradient(140deg, rgba(15,23,42,0.96), rgba(12,23,45,0.96));
      box-shadow: 0 16px 30px rgba(15,23,42,0.85);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-chip {
      margin-top: 2px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .summary-value.accent {
      color: var(--accent);
    }

    .summary-value.success {
      color: var(--accent-2);
    }

    .section {
      margin-top: 22px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .section-header h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.7rem;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
    }

    .chip strong {
      color: var(--accent);
      font-weight: 500;
    }

    .tasks-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(56,189,248,0.12) 0, #020617 50%, #020617 100%);
    }

    .tasks-phase {
      font-weight: 600;
      color: var(--accent-2);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    tfoot td {
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      font-weight: 500;
      background: radial-gradient(circle at top, rgba(56,189,248,0.18) 0, rgba(15,23,42,0.95) 55%, #020617 100%);
    }

    .align-right {
      text-align: right;
    }

    .muted {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .danger {
      color: var(--danger);
    }

    .footer-note {
      margin-top: 16px;
      font-size: 0.76rem;
      color: var(--muted);
      text-align: right;
    }

    .footer-note span {
      color: var(--accent);
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card-actions-buttons {
      display: flex;
      align-items: stretch;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .file-input-label {
      position: relative;
      overflow: hidden;
    }

    .file-input-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .import-status {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
    }
    .import-status.error { color: var(--danger); }

    .card-actions .ghost-button,
    .card-actions .file-input-label {
      flex: 1 1 180px;
      min-height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: rgba(56, 189, 248, 0.05);
      border-color: rgba(56, 189, 248, 0.18);
      color: var(--text);
      font-weight: 500;
    }

    .card-actions .ghost-button:hover,
    .card-actions .file-input-label:hover {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.32);
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <img src="assets/logo.webp" alt="Logo Takamoa" class="brand-logo-img">
        <span class="brand-subtitle">SITE VITRINE SUR-MESURE</span>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        Temps r√©el ¬∑ Devis modulaire
      </div>
    </header>

    <main>
      <div class="column-stack">
        <!-- COLONNE 1 : Param√®tres projet -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">‚öô</span> Param√®tres du projet</h2>
              <p class="sub">Renseigne le volume de travail, la complexit√© et ta marge.</p>
            </div>
            <div class="tag">
              <span class="tag-dot"></span>
              Mode freelance ¬∑ multi-r√¥les
            </div>
          </div>

          <div class="card-actions" aria-label="Import et export des param√®tres du calculateur">
            <div class="card-actions-buttons">
              <button type="button" id="export_params" class="ghost-button">Exporter les param√®tres</button>
              <label class="ghost-button file-input-label">
                Importer un fichier
                <input type="file" id="import_params" accept="application/json" aria-label="Importer des param√®tres JSON">
              </label>
            </div>
            <span id="import_status" class="import-status" aria-live="polite"></span>
          </div>

          <div class="field-groups">
            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üéØ</span> Cadre du projet</h3>
                <p class="group-sub">Pr√©cise le contexte g√©n√©ral et la complexit√©.</p>
              </div>
              <div class="grid" aria-label="Cadre g√©n√©ral du projet">
                <div class="field">
                  <label for="param_type_site">
                    Type de site
                    <span class="hint">applique un preset</span>
                  </label>
                  <div class="control-row">
                    <select id="param_type_site">
                      <option value="landing">Landing Page</option>
                      <option value="vitrine" selected>Site vitrine</option>
                      <option value="vitrine_avancee">Vitrine avanc√©e</option>
                    </select>
                    <button type="button" id="preset_reset" class="ghost-button">Reset</button>
                  </div>
                </div>

                <div class="field">
                  <label for="param_comment">
                    Intitul√© du projet
                    <span class="hint">pour tes exports</span>
                  </label>
                  <input type="text" id="param_comment" placeholder="Site vitrine pour EVADIA‚Ä¶">
                </div>

                <div class="field">
                  <label for="param_complexity">
                    Complexit√© globale
                    <span class="hint">multiplie toutes les t√¢ches</span>
                  </label>
                  <select id="param_complexity">
                    <option value="1">Simple (x1.0)</option>
                    <option value="1.2" selected>Standard (x1.2)</option>
                    <option value="1.5">Complexe (x1.5)</option>
                  </select>
                </div>

                <div class="field">
                  <label for="param_buffer">
                    Buffer impr√©vus
                    <span class="hint">en % sur le co√ªt interne</span>
                  </label>
                  <input type="number" id="param_buffer" min="0" step="5" value="10">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üìÑ</span> Structure du site</h3>
                <p class="group-sub">Organise les pages pr√©vues pour le projet.</p>
              </div>
              <div class="grid" aria-label="Structure du site">
                <div class="field">
                  <label for="param_nb_home">
                    Nb. pages d'accueil (variantes)
                  </label>
                  <input type="number" id="param_nb_home" min="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_nb_pages">
                    Nb. pages internes
                    <span class="hint">hors home, services, blog et pages l√©gales</span>
                  </label>
                  <input type="number" id="param_nb_pages" min="0" step="1" value="4">
                </div>

                <div class="field">
                  <label for="param_nb_legal">
                    Pages l√©gales (incluses)
                    <span class="hint">mentions l√©gales, CGV, politique‚Ä¶</span>
                  </label>
                  <input type="number" id="param_nb_legal" min="0" step="1" value="3">
                </div>

                <div class="field">
                  <label for="param_nb_seo">
                    Pages optimis√©es SEO
                  </label>
                  <input type="number" id="param_nb_seo" min="0" step="1" value="5">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üõ†Ô∏è</span> Pages services</h3>
                <p class="group-sub">D√©taille les gabarits de ta page services et des fiches.</p>
              </div>
              <div class="grid" aria-label="Pages services et gabarits">
                <div class="field">
                  <label for="param_service_listing">
                    Page Services (listing)
                    <span class="hint">0 = non pr√©vue, 1 = incluse</span>
                  </label>
                  <input type="number" id="param_service_listing" min="0" max="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_service_details">
                    Nb. pages d√©tail service
                    <span class="hint">hors page listing</span>
                  </label>
                  <input type="number" id="param_service_details" min="0" step="1" value="3">
                </div>

                <div class="field">
                  <label for="param_service_design_mode">
                    Design des pages service
                    <span class="hint">impacte les heures de design/dev</span>
                  </label>
                  <select id="param_service_design_mode">
                    <option value="1">Gabarit unique pour tous les services</option>
                    <option value="1.4">Design sp√©cifique par service (+40%)</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üèÜ</span> Pages r√©alisations</h3>
                <p class="group-sub">Ajuste le volume d'√©tudes de cas et le niveau de personnalisation.</p>
              </div>
              <div class="grid" aria-label="Pages r√©alisations et √©tudes de cas">
                <div class="field">
                  <label for="param_rea_listing">
                    Page R√©alisations (listing)
                    <span class="hint">0 = non pr√©vue, 1 = incluse</span>
                  </label>
                  <input type="number" id="param_rea_listing" min="0" max="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_rea_details">
                    Nb. √©tudes de cas d√©taill√©es
                    <span class="hint">hors page listing</span>
                  </label>
                  <input type="number" id="param_rea_details" min="0" step="1" value="3">
                </div>

                <div class="field">
                  <label for="param_rea_design_mode">
                    Design des pages r√©alisations
                    <span class="hint">impacte les heures de design/dev</span>
                  </label>
                  <select id="param_rea_design_mode">
                    <option value="1">Gabarit unique pour toutes les √©tudes</option>
                    <option value="1.4">Design sp√©cifique par √©tude (+40%)</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üì∞</span> Blog & contenu</h3>
                <p class="group-sub">Active le blog et ajuste l'import des articles migr√©s.</p>
              </div>
              <div class="grid" aria-label="Blog et import d'articles">
                <div class="field">
                  <label for="param_has_blog">
                    Activer le blog ?
                    <span class="hint">0 = non, 1 = oui</span>
                  </label>
                  <input type="number" id="param_has_blog" min="0" max="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_import_articles">
                    Articles √† importer (refonte)
                    <span class="hint">uniquement si blog activ√©</span>
                  </label>
                  <input type="number" id="param_import_articles" min="0" step="1" value="0">
                </div>

                <div class="field">
                  <label for="param_import_batch_size">
                    Articles par batch d'import
                    <span class="hint">pour le calcul d√©gressif</span>
                  </label>
                  <input type="number" id="param_import_batch_size" min="1" step="1" value="10">
                </div>

                <div class="field">
                  <label for="param_import_base_cost">
                    Co√ªt initial par batch (‚Ç¨)
                    <span class="hint">avant d√©gressivit√©</span>
                  </label>
                  <input type="number" id="param_import_base_cost" min="0" step="10" value="120">
                </div>

                <div class="field">
                  <label for="param_import_degressif">
                    Facteur d√©gressif par batch
                    <span class="hint">0.9 = -10% par batch suppl√©mentaire</span>
                  </label>
                  <input type="number" id="param_import_degressif" min="0" max="1.5" step="0.05" value="0.9">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üß∞</span> Options & accompagnement</h3>
                <p class="group-sub">Services compl√©mentaires √† activer.</p>
              </div>
              <div class="grid" aria-label="Options et accompagnement">
                <div class="field">
                  <label for="param_opt_logo">
                    Cr√©ation / refonte de logo ?
                    <span class="hint">0 = non, 1 = oui</span>
                  </label>
                  <input type="number" id="param_opt_logo" min="0" max="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_opt_formation">
                    Formation client ?
                    <span class="hint">0 = non, 1 = oui</span>
                  </label>
                  <input type="number" id="param_opt_formation" min="0" max="1" step="1" value="1">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üí∞</span> Marges & taux</h3>
                <p class="group-sub">Adapter le prix final au contexte financier.</p>
              </div>
              <div class="grid" aria-label="Marge et taux de change">
                <div class="field">
                  <label for="param_margin">
                    Coefficient de marge agence
                    <span class="hint">ex : 1.3 = +30%</span>
                  </label>
                  <input type="number" id="param_margin" min="1" step="0.05" value="1.3">
                </div>

                <div class="field">
                  <label for="param_fx">
                    Taux de change ‚Ç¨ ‚Üí MGA
                    <span class="hint">approximatif</span>
                  </label>
                  <input type="number" id="param_fx" min="1" step="50" value="5000">
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- COLONNE 1 : R√¥les & tarifs -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üë•</span> R√¥les & tarifs</h2>
              <p class="sub">Ajuste les taux horaires freelance. Tous les co√ªts se recalculent.</p>
            </div>
            <div class="tag">
              <span class="tag-dot"></span>
              Taux horaires en ‚Ç¨/h
            </div>
          </div>

          <div class="roles-table-wrapper roles-table" aria-label="Table des r√¥les et taux horaires">
            <table>
              <thead>
                <tr>
                  <th>R√¥le</th>
                  <th>Taux horaire (‚Ç¨)</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="roles-body">
                <!-- lignes g√©n√©r√©es en JS -->
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-stack sticky-summary">
        <!-- COLONNE 2 : R√©sum√©s rapides -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üß≠</span> R√©sum√© rapide</h2>
              <p class="sub">Vue d'ensemble des volumes et options activ√©es.</p>
            </div>
          </div>
          <div class="section">
            <div class="section-header">
              <div class="chip-group">
                <span class="chip"><strong>Pages</strong> : home + internes</span>
                <span class="chip"><strong>Options</strong> : logo, formation, SEO</span>
              </div>
            </div>
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Volume de pages</div>
                <div class="summary-value" id="summary-pages">‚Äî</div>
                <div class="summary-chip muted">Home + internes (services / blog inclus si activ√©s)</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Complexit√© appliqu√©e</div>
                <div class="summary-value accent" id="summary-complexity">x1.2</div>
                <div class="summary-chip">Simple / Standard / Complexe</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Options activ√©es</div>
                <div class="summary-value" id="summary-options">‚Äî</div>
                <div class="summary-chip muted">Logo, formation, services, blog, SEO on-page</div>
              </div>
            </div>
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Pages l√©gales</div>
                <div class="summary-value" id="summary-legal-pages">‚Äî</div>
                <div class="summary-chip muted">Toujours compt√©es dans les internes</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Blog & import</div>
                <div class="summary-value" id="summary-import">‚Äî</div>
                <div class="summary-chip muted">Activation du blog + co√ªt d√©gressif</div>
              </div>
            </div>
          </div>
        </section>

        <!-- COLONNE 2 : R√©sum√© financier -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üí∞</span> R√©sum√© financier</h2>
              <p class="sub">Synth√®se imm√©diate des montants g√©n√©r√©s par tes param√®tres.</p>
            </div>
          </div>
          <div class="section">
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Co√ªt interne estim√©</div>
                <div class="summary-value" id="summary-cost-internal">‚Äî</div>
                <div class="summary-chip muted">Freelances + import + buffer</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Prix conseill√© HT (‚Ç¨)</div>
                <div class="summary-value success" id="summary-price-sell">‚Äî</div>
                <div class="summary-chip">Marge agence + buffer impr√©vus</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Prix conseill√© HT (MGA)</div>
                <div class="summary-value accent" id="summary-price-sell-mga">‚Äî</div>
                <div class="summary-chip muted">Conversion indicative en Ariary</div>
              </div>
            </div>
          </div>

          <p class="footer-note">
            Astuce : tu peux dupliquer ce mod√®le et fixer le r√©sultat comme <span>base de devis</span> pour ton client.
          </p>
        </section>
      </div>
    </main>

    <!-- SECTION D√âTAIL DES T√ÇCHES -->
    <section class="section" style="margin-top: 26px;">
      <div class="card">
        <div class="section-header">
          <h3>D√©tail des t√¢ches & temps estim√©s</h3>
          <span class="muted">Les heures tiennent compte du volume, de la complexit√© et des options activ√©es.</span>
        </div>

        <div class="tasks-table-wrapper" aria-label="D√©tail des t√¢ches et calculs">
          <table>
            <thead>
              <tr>
                <th>Phase</th>
                <th>T√¢che</th>
                <th>R√¥le</th>
                <th class="align-right">Base h</th>
                <th class="align-right">Volume</th>
                <th class="align-right">Heures totales</th>
                <th class="align-right">Taux ‚Ç¨/h</th>
                <th class="align-right">Co√ªt t√¢che (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody id="tasks-body">
              <!-- lignes g√©n√©r√©es en JS -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="align-right">Total heures</td>
                <td class="align-right" id="tfoot-hours">‚Äî</td>
                <td></td>
                <td class="align-right" id="tfoot-cost">‚Äî</td>
              </tr>
              <tr>
                <td colspan="7" class="align-right">Blog : importation d'articles (refonte)</td>
                <td class="align-right" id="tfoot-import">‚Äî</td>
              </tr>
              <tr>
                <td colspan="7" class="align-right">Total co√ªts avant buffer</td>
                <td class="align-right" id="tfoot-prebuffer">‚Äî</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----- Donn√©es de base -----

    const roles = [
      {
        id: "cp",
        name: "Chef de projet / Relation client",
        rate: 30,
        note: "R√©unions, cadrage, suivi client"
      },
      {
        id: "ux",
        name: "Webdesigner / UX-UI",
        rate: 35,
        note: "Maquettes, UI, parcours utilisateur"
      },
      {
        id: "dev",
        name: "D√©veloppeur WordPress",
        rate: 40,
        note: "Int√©gration, th√®me, plugins"
      },
      {
        id: "graph",
        name: "Graphiste",
        rate: 28,
        note: "Logo, charte, visuels"
      },
      {
        id: "seo",
        name: "R√©dacteur / SEO",
        rate: 30,
        note: "Contenu & on-page SEO"
      },
      {
        id: "qa",
        name: "QA / Tests",
        rate: 25,
        note: "Recette, tests responsive"
      }
    ];

    const tasks = [
      // Cadrage
      {
        id: "atelier",
        phase: "Cadrage",
        label: "Atelier de d√©couverte & cadrage",
        roleId: "cp",
        baseHours: 3,
        volumeKey: "const"
      },
      {
        id: "cdc",
        phase: "Cadrage",
        label: "R√©daction cahier des charges",
        roleId: "cp",
        baseHours: 4,
        volumeKey: "const"
      },
      // Design
      {
        id: "design_home",
        phase: "Design",
        label: "Maquette page d'accueil",
        roleId: "ux",
        baseHours: 6,
        volumeKey: "nbHome"
      },
      {
        id: "design_internes",
        phase: "Design",
        label: "Maquettes pages internes",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "nbInternalPages"
      },
      {
        id: "design_services_listing",
        phase: "Design",
        label: "Maquette page Services",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "serviceListing"
      },
      {
        id: "design_services_details",
        phase: "Design",
        label: "Maquettes fiches service",
        roleId: "ux",
        baseHours: 2.5,
        volumeKey: "serviceDetailsWeighted"
      },
      {
        id: "design_realisations_listing",
        phase: "Design",
        label: "Maquette page R√©alisations",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "reaListing"
      },
      {
        id: "design_realisations_details",
        phase: "Design",
        label: "Maquettes √©tudes de cas",
        roleId: "ux",
        baseHours: 2.5,
        volumeKey: "reaDetailsWeighted"
      },
      {
        id: "design_blog",
        phase: "Design",
        label: "Maquettes blog (listing + article)",
        roleId: "ux",
        baseHours: 4,
        volumeKey: "hasBlog"
      },
      // Graphisme
      {
        id: "logo",
        phase: "Graphisme",
        label: "Cr√©ation / refonte de logo",
        roleId: "graph",
        baseHours: 5,
        volumeKey: "optLogo"
      },
      // D√©veloppement
      {
        id: "dev_home",
        phase: "D√©veloppement",
        label: "Int√©gration page d'accueil",
        roleId: "dev",
        baseHours: 6,
        volumeKey: "nbHome"
      },
      {
        id: "dev_pages",
        phase: "D√©veloppement",
        label: "Int√©gration pages internes",
        roleId: "dev",
        baseHours: 3,
        volumeKey: "nbInternalPages"
      },
      {
        id: "dev_services_listing",
        phase: "D√©veloppement",
        label: "Int√©gration page Services",
        roleId: "dev",
        baseHours: 4,
        volumeKey: "serviceListing"
      },
      {
        id: "dev_services_details",
        phase: "D√©veloppement",
        label: "Int√©gration fiches service",
        roleId: "dev",
        baseHours: 3.5,
        volumeKey: "serviceDetailsWeighted"
      },
      {
        id: "dev_realisations_listing",
        phase: "D√©veloppement",
        label: "Int√©gration page R√©alisations",
        roleId: "dev",
        baseHours: 4,
        volumeKey: "reaListing"
      },
      {
        id: "dev_realisations_details",
        phase: "D√©veloppement",
        label: "Int√©gration √©tudes de cas",
        roleId: "dev",
        baseHours: 3.5,
        volumeKey: "reaDetailsWeighted"
      },
      {
        id: "dev_blog",
        phase: "D√©veloppement",
        label: "Int√©gration blog (listing + article)",
        roleId: "dev",
        baseHours: 5,
        volumeKey: "hasBlog"
      },
      {
        id: "dev_config",
        phase: "D√©veloppement",
        label: "Configuration WordPress & plugins",
        roleId: "dev",
        baseHours: 3,
        volumeKey: "const"
      },
      // SEO
      {
        id: "seo_pages",
        phase: "SEO",
        label: "Optimisation SEO on-page",
        roleId: "seo",
        baseHours: 1.5,
        volumeKey: "nbSeoPages"
      },
      // Recette
      {
        id: "tests",
        phase: "Recette",
        label: "Tests responsive & bugfix",
        roleId: "qa",
        baseHours: 4,
        volumeKey: "const"
      },
      // Formation
      {
        id: "formation",
        phase: "Formation",
        label: "Session de formation client",
        roleId: "cp",
        baseHours: 2,
        volumeKey: "optFormation"
      }
    ];

    const rolesById = {};
    roles.forEach(r => rolesById[r.id] = r);

    const SITE_PRESETS = {
      landing: {
        label: "Landing Page",
        values: {
          param_nb_home: 1,
          param_nb_pages: 1,
          param_nb_legal: 2,
          param_nb_seo: 2,
          param_service_listing: 0,
          param_service_details: 0,
          param_service_design_mode: 1,
          param_rea_listing: 0,
          param_rea_details: 0,
          param_rea_design_mode: 1,
          param_has_blog: 0,
          param_opt_logo: 0,
          param_opt_formation: 0,
          param_complexity: 1,
          param_margin: 1.3,
          param_fx: 5000,
          param_buffer: 10,
          param_import_articles: 0,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      },
      vitrine: {
        label: "Site vitrine",
        values: {
          param_nb_home: 1,
          param_nb_pages: 4,
          param_nb_legal: 3,
          param_nb_seo: 5,
          param_service_listing: 1,
          param_service_details: 3,
          param_service_design_mode: 1,
          param_rea_listing: 1,
          param_rea_details: 3,
          param_rea_design_mode: 1,
          param_has_blog: 1,
          param_opt_logo: 0,
          param_opt_formation: 0,
          param_complexity: 1.2,
          param_margin: 1.3,
          param_fx: 5000,
          param_buffer: 10,
          param_import_articles: 0,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      },
      vitrine_avancee: {
        label: "Vitrine avanc√©e",
        values: {
          param_nb_home: 1,
          param_nb_pages: 8,
          param_nb_legal: 3,
          param_nb_seo: 12,
          param_service_listing: 1,
          param_service_details: 6,
          param_service_design_mode: 1.4,
          param_rea_listing: 1,
          param_rea_details: 6,
          param_rea_design_mode: 1.4,
          param_has_blog: 1,
          param_opt_logo: 1,
          param_opt_formation: 1,
          param_complexity: 1.5,
          param_margin: 1.35,
          param_fx: 5000,
          param_buffer: 12,
          param_import_articles: 15,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      }
    };

    // ----- Helpers -----

    function safeNumber(value, fallback = 0) {
      const n = Number(value);
      if (Number.isNaN(n)) return fallback;
      return n;
    }

    function fmtEuro(num, digits = 0) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      }) + " ‚Ç¨";
    }

    function fmtMGA(num) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }) + " MGA";
    }

    function fmtHours(num) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      });
    }

    function applyPreset(key) {
      const preset = SITE_PRESETS[key];
      if (!preset) return;

      Object.entries(preset.values).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = value;
      });

      recalcAll();
    }

    const PARAM_INPUT_IDS = [
      "param_complexity",
      "param_nb_home",
      "param_nb_pages",
      "param_nb_legal",
      "param_nb_seo",
      "param_service_listing",
      "param_service_details",
      "param_service_design_mode",
      "param_rea_listing",
      "param_rea_details",
      "param_rea_design_mode",
      "param_has_blog",
      "param_opt_logo",
      "param_opt_formation",
      "param_margin",
      "param_fx",
      "param_buffer",
      "param_import_articles",
      "param_import_batch_size",
      "param_import_base_cost",
      "param_import_degressif"
    ];

    const ALL_INPUT_IDS = [...PARAM_INPUT_IDS, "param_type_site", "param_comment"];

    function readParams() {
      const nbHome = Math.max(1, safeNumber(document.getElementById("param_nb_home").value, 1));
      const nbPages = Math.max(0, safeNumber(document.getElementById("param_nb_pages").value, 0));
      const nbLegal = Math.max(0, safeNumber(document.getElementById("param_nb_legal").value, 0));
      const nbSeoPages = Math.max(0, safeNumber(document.getElementById("param_nb_seo").value, 0));
      const nbServiceListing = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_service_listing").value, 1)));
      const nbServiceDetails = Math.max(0, safeNumber(document.getElementById("param_service_details").value, 0));
      const serviceDesignFactor = safeNumber(document.getElementById("param_service_design_mode").value, 1);
      const nbReaListing = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_rea_listing").value, 1)));
      const nbReaDetails = Math.max(0, safeNumber(document.getElementById("param_rea_details").value, 0));
      const reaDesignFactor = safeNumber(document.getElementById("param_rea_design_mode").value, 1);
      const hasBlog = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_has_blog").value, 1)));
      const optLogo = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_logo").value, 0)));
      const optFormation = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_formation").value, 0)));
      const complexity = safeNumber(document.getElementById("param_complexity").value, 1);
      const margin = Math.max(1, safeNumber(document.getElementById("param_margin").value, 1.3));
      const fx = Math.max(1, safeNumber(document.getElementById("param_fx").value, 5000));
      const bufferPercent = Math.max(0, safeNumber(document.getElementById("param_buffer").value, 0));
      const importArticlesRaw = Math.max(0, safeNumber(document.getElementById("param_import_articles").value, 0));
      const importArticles = hasBlog ? importArticlesRaw : 0;
      const importBatchSize = Math.max(1, safeNumber(document.getElementById("param_import_batch_size").value, 1));
      const importBaseCost = Math.max(0, safeNumber(document.getElementById("param_import_base_cost").value, 0));
      const importDegressive = Math.max(0, safeNumber(document.getElementById("param_import_degressif").value, 1));

      const totalInternalPages = nbPages + nbLegal;
      const totalPagesWithExtras = totalInternalPages + nbServiceListing + nbServiceDetails + nbReaListing + nbReaDetails + (hasBlog ? 2 : 0);

      return {
        nbHome,
        nbPages,
        nbLegal,
        totalInternalPages,
        totalPagesWithExtras,
        nbSeoPages,
        nbServiceListing,
        nbServiceDetails,
        serviceDesignFactor,
        nbReaListing,
        nbReaDetails,
        reaDesignFactor,
        hasBlog,
        optLogo,
        optFormation,
        complexity,
        margin,
        fx,
        bufferPercent,
        importArticles,
        importBatchSize,
        importBaseCost,
        importDegressive
      };
    }

    function computeImportCost(importArticles, batchSize, baseCost, degressive) {
      if (importArticles <= 0 || batchSize <= 0 || baseCost <= 0) {
        return { cost: 0, batches: 0 };
      }

      const batches = Math.ceil(importArticles / batchSize);
      let cost = 0;

      for (let i = 0; i < batches; i++) {
        cost += baseCost * Math.pow(degressive, i);
      }

      return { cost, batches };
    }

    function getTaskVolume(task, params) {
      switch (task.volumeKey) {
        case "nbHome": return params.nbHome;
        case "nbInternalPages": return params.totalInternalPages;
        case "nbSeoPages": return params.nbSeoPages;
        case "optLogo": return params.optLogo;
        case "optFormation": return params.optFormation;
        case "serviceListing": return params.nbServiceListing;
        case "serviceDetailsWeighted": return params.nbServiceDetails * params.serviceDesignFactor;
        case "reaListing": return params.nbReaListing;
        case "reaDetailsWeighted": return params.nbReaDetails * params.reaDesignFactor;
        case "hasBlog": return params.hasBlog;
        case "const":
        default:
          return 1;
      }
    }

    // ----- Initialisation UI -----

    function initRolesTable() {
      const tbody = document.getElementById("roles-body");
      tbody.innerHTML = "";
      roles.forEach(role => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = role.name;

        const tdRate = document.createElement("td");
        tdRate.className = "align-right";
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = role.rate;
        input.dataset.roleId = role.id;
        input.addEventListener("input", () => {
          role.rate = safeNumber(input.value, role.rate);
          recalcAll();
        });
        tdRate.appendChild(input);

        const tdNote = document.createElement("td");
        tdNote.textContent = role.note;

        tr.appendChild(tdName);
        tr.appendChild(tdRate);
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      });
    }

    function initTasksTable() {
      const tbody = document.getElementById("tasks-body");
      tbody.innerHTML = "";
      tasks.forEach(task => {
        const tr = document.createElement("tr");
        tr.dataset.taskId = task.id;

        const tdPhase = document.createElement("td");
        tdPhase.innerHTML = `<span class="tasks-phase">${task.phase}</span>`;

        const tdLabel = document.createElement("td");
        tdLabel.textContent = task.label;

        const tdRole = document.createElement("td");
        tdRole.textContent = rolesById[task.roleId]?.name || "‚Äî";

        const tdBase = document.createElement("td");
        tdBase.className = "align-right";
        tdBase.textContent = fmtHours(task.baseHours);

        const tdVolume = document.createElement("td");
        tdVolume.className = "align-right";
        tdVolume.textContent = "‚Äî";
        tdVolume.dataset.type = "volume";

        const tdHours = document.createElement("td");
        tdHours.className = "align-right";
        tdHours.textContent = "‚Äî";
        tdHours.dataset.type = "hours";

        const tdRate = document.createElement("td");
        tdRate.className = "align-right";
        tdRate.textContent = "‚Äî";
        tdRate.dataset.type = "rate";

        const tdCost = document.createElement("td");
        tdCost.className = "align-right";
        tdCost.textContent = "‚Äî";
        tdCost.dataset.type = "cost";

        tr.appendChild(tdPhase);
        tr.appendChild(tdLabel);
        tr.appendChild(tdRole);
        tr.appendChild(tdBase);
        tr.appendChild(tdVolume);
        tr.appendChild(tdHours);
        tr.appendChild(tdRate);
        tr.appendChild(tdCost);

        tbody.appendChild(tr);
      });
    }

    // ----- Recalcul global -----

    function recalcAll() {
      const params = readParams();
      const importResult = computeImportCost(
        params.importArticles,
        params.importBatchSize,
        params.importBaseCost,
        params.importDegressive
      );

      // R√©sum√© simple
      document.getElementById("summary-pages").textContent =
        `${params.nbHome} home ¬∑ ${params.totalPagesWithExtras} internes`;
      document.getElementById("summary-complexity").textContent =
        `x${params.complexity.toLocaleString("fr-FR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}`;
      document.getElementById("summary-legal-pages").textContent =
        params.nbLegal > 0
          ? `${params.nbLegal} pages l√©gales incluses`
          : "Aucune page l√©gale";
      const opts = [];
      if (params.optLogo === 1) opts.push("Logo");
      if (params.optFormation === 1) opts.push("Formation");
      if (params.hasBlog === 1) opts.push("Blog");
      if (params.nbServiceListing === 1 || params.nbServiceDetails > 0) {
        const detailLabel = params.nbServiceDetails > 0 ? `${params.nbServiceDetails} fiches` : "listing seul";
        const designLabel = params.serviceDesignFactor > 1 ? "design d√©di√©" : "gabarit unique";
        opts.push(`Services ${detailLabel} (${designLabel})`);
      }
      if (params.nbReaListing === 1 || params.nbReaDetails > 0) {
        const detailLabel = params.nbReaDetails > 0 ? `${params.nbReaDetails} cas` : "listing seul";
        const designLabel = params.reaDesignFactor > 1 ? "design d√©di√©" : "gabarit unique";
        opts.push(`R√©alisations ${detailLabel} (${designLabel})`);
      }
      if (params.nbSeoPages > 0) opts.push(`SEO x${params.nbSeoPages}`);
      if (importResult.batches > 0) opts.push(`Import ${params.importArticles} art.`);
      document.getElementById("summary-options").textContent =
        opts.length ? opts.join(" ¬∑ ") : "Aucune option";
      document.getElementById("summary-import").textContent =
        params.hasBlog === 0
          ? "Blog non pr√©vu"
          : importResult.batches > 0
            ? `Blog activ√© ¬∑ ${params.importArticles} art. / ${importResult.batches} batchs ‚Üí ${fmtEuro(importResult.cost, 0)}`
            : "Blog activ√© ¬∑ pas d'import";

      // D√©tail des t√¢ches
      const tbody = document.getElementById("tasks-body");
      let totalHours = 0;
      let totalCost = 0;

      tasks.forEach(task => {
        const row = tbody.querySelector(`tr[data-task-id="${task.id}"]`);
        if (!row) return;

        const volume = getTaskVolume(task, params);
        const hours = task.baseHours * volume * params.complexity;
        const rate = rolesById[task.roleId]?.rate ?? 0;
        const cost = hours * rate;

        totalHours += hours;
        totalCost += cost;

        row.querySelector('td[data-type="volume"]').textContent =
          volume.toLocaleString("fr-FR", { maximumFractionDigits: 1 });
        row.querySelector('td[data-type="hours"]').textContent = fmtHours(hours);
        row.querySelector('td[data-type="rate"]').textContent = fmtEuro(rate, 0);
        row.querySelector('td[data-type="cost"]').textContent = fmtEuro(cost, 0);
      });

      document.getElementById("tfoot-hours").textContent = fmtHours(totalHours);
      document.getElementById("tfoot-cost").textContent = fmtEuro(totalCost, 0);
      document.getElementById("tfoot-import").textContent = fmtEuro(importResult.cost, 0);
      document.getElementById("tfoot-prebuffer").textContent = fmtEuro(totalCost + importResult.cost, 0);

      // Buffer impr√©vus
      const bufferAmount = (totalCost + importResult.cost) * (params.bufferPercent / 100);
      const internalWithBuffer = totalCost + importResult.cost + bufferAmount;

      // Prix de vente
      const priceSell = internalWithBuffer * params.margin;
      const priceSellMGA = priceSell * params.fx;

      document.getElementById("summary-cost-internal").textContent = fmtEuro(internalWithBuffer, 0);
      document.getElementById("summary-price-sell").textContent = fmtEuro(priceSell, 0);
      document.getElementById("summary-price-sell-mga").textContent = fmtMGA(priceSellMGA);
    }

    function bindParamEvents() {
      PARAM_INPUT_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === "SELECT" ? "change" : "input";
        el.addEventListener(evt, recalcAll);
      });
    }

    function bindPresetControls() {
      const select = document.getElementById("param_type_site");
      const resetBtn = document.getElementById("preset_reset");

      if (select) {
        select.addEventListener("change", () => applyPreset(select.value));
      }

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          if (select) {
            applyPreset(select.value);
          }
        });
      }
    }

    function setImportStatus(message, isError = false) {
      const status = document.getElementById("import_status");
      if (!status) return;
      status.textContent = message;
      status.classList.toggle("error", Boolean(isError));
    }

    function serializeInputs() {
      const inputs = {};
      ALL_INPUT_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        inputs[id] = el.value;
      });
      return inputs;
    }

    function refreshRoleInputs() {
      document.querySelectorAll('#roles-body input[data-role-id]').forEach(input => {
        const role = rolesById[input.dataset.roleId];
        if (role) {
          input.value = role.rate;
        }
      });
    }

    function buildExportState() {
      return {
        meta: {
          exportedAt: new Date().toISOString()
        },
        inputs: serializeInputs(),
        roles: roles.map(role => ({ id: role.id, rate: role.rate }))
      };
    }

    function slugifyComment(comment) {
      const base = comment.trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
      return base || "calculateur-devis";
    }

    function exportParams() {
      const state = buildExportState();
      const comment = document.getElementById("param_comment")?.value || "";
      const date = new Date();
      const stamp = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
      const filename = `${slugifyComment(comment)}-${stamp}.json`;
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
      setImportStatus(`Export pr√™t (${filename})`);
    }

    function applyImportedState(data) {
      if (!data || typeof data !== "object") {
        throw new Error("Fichier invalide");
      }

      const inputs = data.inputs || {};
      ALL_INPUT_IDS.forEach(id => {
        if (!Object.prototype.hasOwnProperty.call(inputs, id)) return;
        const el = document.getElementById(id);
        if (el) {
          el.value = inputs[id];
        }
      });

      if (Array.isArray(data.roles)) {
        data.roles.forEach(r => {
          if (!r || typeof r !== "object") return;
          const role = rolesById[r.id];
          const rate = safeNumber(r.rate, role?.rate ?? 0);
          if (role) {
            role.rate = rate;
          }
        });
        refreshRoleInputs();
      }

      recalcAll();
      setImportStatus("Param√®tres import√©s avec succ√®s");
    }

    function handleImportFile(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          applyImportedState(data);
        } catch (err) {
          setImportStatus("Import impossible : fichier invalide", true);
        }
      };
      reader.onerror = () => setImportStatus("Import impossible : lecture √©chou√©e", true);
      reader.readAsText(file);

      // reset input value to allow re-importing the same file
      event.target.value = "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      initRolesTable();
      initTasksTable();
      bindPresetControls();
      bindParamEvents();
      document.getElementById("export_params")?.addEventListener("click", exportParams);
      document.getElementById("import_params")?.addEventListener("change", handleImportFile);
      const presetSelect = document.getElementById("param_type_site");
      const initialPreset = presetSelect?.value ?? "vitrine";
      applyPreset(initialPreset);
    });
  </script>
</body>
</html>
