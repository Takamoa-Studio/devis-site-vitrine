<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur de co√ªt - Site vitrine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #020617;
      --card: #020617;
      --card-soft: #0b1220;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --accent-2: #4ade80;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
      --shadow-chip: 0 10px 24px rgba(15, 23, 42, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d283a 0, #020617 45%, #000 100%);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    h1 {
      font-size: clamp(1.7rem, 3vw, 2.2rem);
    }

    h2 {
      font-size: 1.1rem;
      text-transform: uppercase;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .brand-logo-img {
      width: 180px;
      height: auto;
      display: block;
      filter: drop-shadow(0 10px 30px rgba(56, 189, 248, 0.35));
    }

    .brand-subtitle {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .pill {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: var(--accent);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-chip);
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 12px rgba(74, 222, 128, 0.9);
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }

      .sticky-summary {
        position: static;
      }
    }

    .column-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sticky-summary {
      position: sticky;
      top: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08) 0, rgba(15,23,42,0.95) 45%, #020617 100%);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(16px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card-header h2 {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card-header h2 span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--accent);
    }

    .card-header p.sub {
      font-size: 0.78rem;
      color: var(--muted);
      margin: 0;
      max-width: 220px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
    }

    .field-groups {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-group {
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.06), rgba(74, 222, 128, 0.04));
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .group-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .group-title {
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .group-title .icon {
      font-size: 0.8rem;
      color: var(--accent);
    }

    .group-sub {
      margin: 0;
      font-size: 0.78rem;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .field label {
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.8rem;
    }

    .hint-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 6px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.35);
      color: var(--accent);
      font-size: 0.68rem;
      font-weight: 700;
      line-height: 1;
      cursor: help;
      transition: border-color 0.15s ease, background 0.15s ease, color 0.15s ease, box-shadow 0.2s ease;
    }

    .hint-icon:hover,
    .hint-icon:focus-visible {
      background: rgba(56, 189, 248, 0.16);
      border-color: rgba(56, 189, 248, 0.6);
      color: #67e8f9;
      box-shadow: 0 10px 24px rgba(56, 189, 248, 0.15);
      outline: none;
    }

    .hint-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      inset: auto auto calc(100% + 10px) auto;
      right: 0;
      min-width: 160px;
      max-width: 260px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(56, 189, 248, 0.25);
      color: var(--text);
      font-size: 0.75rem;
      line-height: 1.3;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.55);
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      white-space: normal;
      z-index: 2;
    }

    .hint-icon:hover::after,
    .hint-icon:focus-visible::after {
      opacity: 1;
      transform: translateY(0);
    }

    .field-subsection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 8px;
      border: 1px dashed rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.35);
    }

    .field-subtitle {
      margin: 0;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .field input[type="number"],
    .field input[type="text"],
    .field select {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px 10px;
      color: var(--text);
      outline: none;
      font-size: 0.82rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      width: 100%;
    }

    .field input[type="number"]:focus,
    .field input[type="text"]:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
      background: rgba(15, 23, 42, 1);
    }

    .field .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .field .control-row select {
      flex: 1 1 auto;
    }

    .ghost-button {
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--accent);
      border-radius: var(--radius-md);
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }

    .ghost-button:hover {
      background: rgba(56, 189, 248, 0.16);
      border-color: rgba(56, 189, 248, 0.5);
      color: #67e8f9;
    }

    .field input::placeholder {
      color: #4b5563;
    }

    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .field-row .title {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .field-row .value {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(56, 189, 248, 0.2);
      font-size: 0.7rem;
      color: var(--muted);
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-2);
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
    }

    .roles-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(56,189,248,0.1) 0, #020617 45%, #020617 100%);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 100%;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    th, td {
      padding: 7px 10px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: #9ca3af;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
    }

    tbody tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.95);
    }

    tbody tr:hover td {
      background: rgba(30, 64, 175, 0.45);
    }

    .roles-table input {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 8px;
      color: var(--text);
      font-size: 0.75rem;
      width: 70px;
      outline: none;
    }

    .roles-table input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    .summary-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      margin-top: 14px;
    }

    @media (max-width: 900px) {
      .summary-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .summary-card {
      padding: 12px 12px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(56, 189, 248, 0.25);
      background: linear-gradient(140deg, rgba(15,23,42,0.96), rgba(12,23,45,0.96));
      box-shadow: 0 16px 30px rgba(15,23,42,0.85);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-chip {
      margin-top: 2px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .summary-value.accent {
      color: var(--accent);
    }

    .summary-value.success {
      color: var(--accent-2);
    }

    .section {
      margin-top: 22px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .section-header h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tasks-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-md);
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.08), rgba(74, 222, 128, 0.05));
      box-shadow: var(--shadow-soft);
    }

    .tasks-toolbar .toolbar-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tasks-toolbar .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tasks-toolbar .toolbar-text label {
      font-size: 0.82rem;
      color: var(--text);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .tasks-toolbar .label-sub {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .filter-select {
      position: relative;
      min-width: 230px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .filter-select .filter-icon {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: rgba(56, 189, 248, 0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.22);
      flex-shrink: 0;
    }

    .filter-select select {
      appearance: none;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.92rem;
      padding: 8px 32px 8px 10px;
      min-width: 190px;
      cursor: pointer;
      transition: border-color 0.12s ease;
    }

    .filter-select select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.6);
    }

    .filter-select select option {
      background: #0b1220;
      color: var(--text);
    }

    .filter-select select option:checked {
      background: rgba(56, 189, 248, 0.14);
      color: var(--accent);
      font-weight: 600;
    }

    .filter-select .select-caret {
      position: absolute;
      right: 12px;
      color: var(--muted);
      font-size: 0.82rem;
      pointer-events: none;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(15, 23, 42, 0.8);
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .toggle:hover {
      border-color: rgba(56, 189, 248, 0.4);
      background: rgba(56, 189, 248, 0.06);
    }

    .toggle input {
      display: none;
    }

    .toggle-switch {
      position: relative;
      width: 42px;
      height: 22px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.3);
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .toggle-switch::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #0b1220;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .toggle input:checked + .toggle-switch {
      background: rgba(74, 222, 128, 0.5);
      border-color: rgba(74, 222, 128, 0.6);
    }

    .toggle input:checked + .toggle-switch::after {
      transform: translateX(20px);
      background: #22c55e;
    }

    .toggle-label {
      font-size: 0.82rem;
      color: var(--text);
      white-space: nowrap;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.7rem;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
    }

    .chip strong {
      color: var(--accent);
      font-weight: 500;
    }

    .tasks-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(56,189,248,0.12) 0, #020617 50%, #020617 100%);
    }

    .tasks-phase {
      font-weight: 600;
      color: var(--accent-2);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .is-hidden {
      display: none !important;
    }

    tfoot td {
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      font-weight: 500;
      background: radial-gradient(circle at top, rgba(56,189,248,0.18) 0, rgba(15,23,42,0.95) 55%, #020617 100%);
    }

    .align-right {
      text-align: right;
    }

    .muted {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .danger {
      color: var(--danger);
    }

    .footer-note {
      margin-top: 16px;
      font-size: 0.76rem;
      color: var(--muted);
      text-align: right;
    }

    .footer-note span {
      color: var(--accent);
    }

    .footer-note b {
      color: var(--text);
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card-actions-buttons {
      display: flex;
      align-items: stretch;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .file-input-label {
      position: relative;
      overflow: hidden;
    }

    .file-input-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .import-status {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
    }
    .import-status.error { color: var(--danger); }

    .card-actions .ghost-button,
    .card-actions .file-input-label {
      flex: 1 1 180px;
      min-height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: rgba(56, 189, 248, 0.05);
      border-color: rgba(56, 189, 248, 0.18);
      color: var(--text);
      font-weight: 500;
    }

    .card-actions .ghost-button:hover,
    .card-actions .file-input-label:hover {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.32);
      color: var(--accent);
    }

    .ghost-button--compact {
      padding: 8px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <img src="assets/logo.webp" alt="Logo Takamoa" class="brand-logo-img">
        <span class="brand-subtitle">SITE VITRINE SUR-MESURE</span>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        Temps r√©el ¬∑ Devis modulaire
      </div>
    </header>

    <main>
      <div class="column-stack">
        <!-- COLONNE 1 : Param√®tres projet -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">‚öô</span> Param√®tres du projet</h2>
              <p class="sub">Renseigne le volume de travail, la complexit√© et ta marge.</p>
            </div>
            <div class="tag">
              <span class="tag-dot"></span>
              Mode freelance ¬∑ multi-r√¥les
            </div>
          </div>

          <div class="card-actions" aria-label="Import et export des param√®tres du calculateur">
            <div class="card-actions-buttons">
              <button type="button" id="export_params" class="ghost-button">Exporter les param√®tres</button>
              <label class="ghost-button file-input-label">
                Importer un fichier
                <input type="file" id="import_params" accept="application/json" aria-label="Importer des param√®tres JSON">
              </label>
            </div>
            <span id="import_status" class="import-status" aria-live="polite"></span>
          </div>

          <div class="field-groups">
            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üéØ</span> Cadre du projet</h3>
                <p class="group-sub">Pr√©cise le contexte g√©n√©ral et la complexit√©.</p>
              </div>
              <div class="grid" aria-label="Cadre g√©n√©ral du projet">
                <div class="field">
                  <label for="param_type_site">
                    Type de site
                    <span class="hint-icon" data-tooltip="applique un preset" role="note" tabindex="0" aria-label="applique un preset">?</span>
                  </label>
                  <div class="control-row">
                    <select id="param_type_site">
                      <option value="landing">Landing Page</option>
                      <option value="vitrine" selected>Site vitrine</option>
                      <option value="vitrine_avancee">Vitrine avanc√©e</option>
                    </select>
                    <button type="button" id="preset_reset" class="ghost-button">Reset</button>
                  </div>
                </div>

                <div class="field">
                  <label for="param_comment">
                    Intitul√© du projet
                    <span class="hint-icon" data-tooltip="pour tes exports" role="note" tabindex="0" aria-label="pour tes exports">?</span>
                  </label>
                  <input type="text" id="param_comment" placeholder="Site vitrine pour EVADIA‚Ä¶">
                </div>

                <div class="field">
                  <label for="param_complexity">
                    Complexit√© globale
                    <span class="hint-icon" data-tooltip="multiplie toutes les t√¢ches" role="note" tabindex="0" aria-label="multiplie toutes les t√¢ches">?</span>
                  </label>
                  <select id="param_complexity">
                    <option value="1">Simple (x1.0)</option>
                    <option value="1.2" selected>Standard (x1.2)</option>
                    <option value="1.5">Complexe (x1.5)</option>
                  </select>
                </div>

                <div class="field">
                  <label for="param_buffer">
                    Buffer impr√©vus
                    <span class="hint-icon" data-tooltip="en % sur le co√ªt interne" role="note" tabindex="0" aria-label="en % sur le co√ªt interne">?</span>
                  </label>
                  <input type="number" id="param_buffer" min="0" step="5" value="10">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üìÑ</span> Structure du site</h3>
                <p class="group-sub">Organise les pages pr√©vues pour le projet.</p>
              </div>
              <div class="grid" aria-label="Structure du site">
                <div class="field">
                  <label for="param_nb_home">
                    Nb. pages d'accueil (variantes)
                  </label>
                  <input type="number" id="param_nb_home" min="1" step="1" value="1">
                </div>

                <div class="field">
                  <label for="param_nb_pages">
                    Nb. pages internes
                    <span class="hint-icon" data-tooltip="hors home, services, blog et pages l√©gales" role="note" tabindex="0" aria-label="hors home, services, blog et pages l√©gales">?</span>
                  </label>
                  <input type="number" id="param_nb_pages" min="0" step="1" value="4">
                </div>

                <div class="field">
                  <label for="param_nb_legal">
                    Pages l√©gales (incluses)
                    <span class="hint-icon" data-tooltip="mentions l√©gales, CGV, politique‚Ä¶" role="note" tabindex="0" aria-label="mentions l√©gales, CGV, politique‚Ä¶">?</span>
                  </label>
                  <input type="number" id="param_nb_legal" min="0" step="1" value="3">
                </div>

                <div class="field">
                  <label for="param_nb_seo">
                    Pages SEO cibl√©es (ajout manuel)
                  </label>
                  <input type="number" id="param_nb_seo" min="0" step="1" value="5">
                </div>

                <div class="field">
                  <label for="param_seo_mode">
                    Intensit√© SEO automatique
                    <span class="hint-icon" data-tooltip="calcule les pages √† optimiser selon le volume" role="note" tabindex="0" aria-label="calcule les pages √† optimiser selon le volume">?</span>
                  </label>
                  <select id="param_seo_mode">
                    <option value="0.6">Essentiel (60% du volume)</option>
                    <option value="1" selected>Standard (100% du volume)</option>
                    <option value="1.3">Renforc√© (130% du volume)</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üõ†Ô∏è</span> Pages services</h3>
                <p class="group-sub">D√©taille les gabarits de ta page services et des fiches.</p>
              </div>
              <div class="field-subsection">
                <p class="field-subtitle">Activation & structure</p>
                <div class="grid" aria-label="Pages services et gabarits">
                  <div class="field">
                    <label for="param_service_listing">
                      Page Services (listing)
                      <span class="hint-icon" data-tooltip="0 = non pr√©vue, 1 = incluse" role="note" tabindex="0" aria-label="0 = non pr√©vue, 1 = incluse">?</span>
                    </label>
                    <input type="number" id="param_service_listing" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_service_details">
                      Nb. pages d√©tail service
                      <span class="hint-icon" data-tooltip="hors page listing" role="note" tabindex="0" aria-label="hors page listing">?</span>
                    </label>
                    <input type="number" id="param_service_details" min="0" step="1" value="3">
                  </div>

                  <div class="field">
                    <label for="param_service_design_mode">
                      Design des pages service
                      <span class="hint-icon" data-tooltip="impacte les heures de design/dev" role="note" tabindex="0" aria-label="impacte les heures de design/dev">?</span>
                    </label>
                    <select id="param_service_design_mode">
                      <option value="1">Gabarit unique pour tous les services</option>
                      <option value="1.4">Design sp√©cifique par service (+40%)</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="field-subsection">
                <p class="field-subtitle">Contenus & SEO</p>
                <div class="grid" aria-label="Contenus et SEO pour les services">
                  <div class="field">
                    <label for="param_service_content">
                      R√©daction + SEO des fiches
                      <span class="hint-icon" data-tooltip="applique la SEO auto sur listing + fiches" role="note" tabindex="0" aria-label="applique la SEO auto sur listing + fiches">?</span>
                    </label>
                    <select id="param_service_content">
                      <option value="1" selected>Oui, couvrir toutes les pages services</option>
                      <option value="0">Non, SEO/r√©daction g√©r√©s ailleurs</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="param_service_visuals">
                      Illustrations pour les services ?
                      <span class="hint-icon" data-tooltip="impacts le volume r√©daction/graphisme" role="note" tabindex="0" aria-label="impacts le volume r√©daction/graphisme">?</span>
                    </label>
                    <select id="param_service_visuals">
                      <option value="1">Oui, un visuel par fiche</option>
                      <option value="0" selected>Non, visuels non pr√©vus</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üèÜ</span> Pages r√©alisations</h3>
                <p class="group-sub">Ajuste le volume d'√©tudes de cas et le niveau de personnalisation.</p>
              </div>
              <div class="field-subsection">
                <p class="field-subtitle">Activation & structure</p>
                <div class="grid" aria-label="Pages r√©alisations et √©tudes de cas">
                  <div class="field">
                    <label for="param_rea_listing">
                      Page R√©alisations (listing)
                      <span class="hint-icon" data-tooltip="0 = non pr√©vue, 1 = incluse" role="note" tabindex="0" aria-label="0 = non pr√©vue, 1 = incluse">?</span>
                    </label>
                    <input type="number" id="param_rea_listing" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_rea_details">
                      Nb. √©tudes de cas d√©taill√©es
                      <span class="hint-icon" data-tooltip="hors page listing" role="note" tabindex="0" aria-label="hors page listing">?</span>
                    </label>
                    <input type="number" id="param_rea_details" min="0" step="1" value="3">
                  </div>

                  <div class="field">
                    <label for="param_rea_design_mode">
                      Design des pages r√©alisations
                      <span class="hint-icon" data-tooltip="impacte les heures de design/dev" role="note" tabindex="0" aria-label="impacte les heures de design/dev">?</span>
                    </label>
                    <select id="param_rea_design_mode">
                      <option value="1">Gabarit unique pour toutes les √©tudes</option>
                      <option value="1.4">Design sp√©cifique par √©tude (+40%)</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="field-subsection">
                <p class="field-subtitle">Contenus & SEO</p>
                <div class="grid" aria-label="Contenus et SEO pour les r√©alisations">
                  <div class="field">
                    <label for="param_rea_content">
                      R√©daction + SEO des √©tudes de cas
                      <span class="hint-icon" data-tooltip="applique la SEO auto sur listing + cas" role="note" tabindex="0" aria-label="applique la SEO auto sur listing + cas">?</span>
                    </label>
                    <select id="param_rea_content">
                      <option value="1" selected>Oui, couvrir toutes les r√©alisations</option>
                      <option value="0">Non, SEO/r√©daction g√©r√©s ailleurs</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="param_rea_visuals">
                      Illustrations pour les r√©alisations ?
                      <span class="hint-icon" data-tooltip="photos, sch√©mas ou mockups" role="note" tabindex="0" aria-label="photos, sch√©mas ou mockups">?</span>
                    </label>
                    <select id="param_rea_visuals">
                      <option value="1">Oui, un visuel par cas</option>
                      <option value="0" selected>Non, pas de visuels d√©di√©s</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üì∞</span> Blog & contenu</h3>
                <p class="group-sub">Active le blog, pr√©pare les nouveaux articles et ajuste l'import d'anciens contenus.</p>
              </div>
              <div class="field-subsection">
                <p class="field-subtitle">Activation & cr√©ation d'articles</p>
                <div class="grid" aria-label="Activation du blog et production d'articles">
                  <div class="field">
                    <label for="param_has_blog">
                      Activer le blog ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_has_blog" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_blog_articles">
                      Articles √† cr√©er
                      <span class="hint-icon" data-tooltip="hors import si refonte" role="note" tabindex="0" aria-label="hors import si refonte">?</span>
                    </label>
                    <input type="number" id="param_blog_articles" min="0" step="1" value="2">
                  </div>

                  <div class="field">
                    <label for="param_blog_visuals">
                      Visuel d√©di√© pour chaque article ?
                      <span class="hint-icon" data-tooltip="impacte graphisme / contenus" role="note" tabindex="0" aria-label="impacte graphisme / contenus">?</span>
                    </label>
                    <select id="param_blog_visuals">
                      <option value="1">Oui, un visuel par article</option>
                      <option value="0">Non, visuels non pr√©vus</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="param_blog_seo">
                      Optimisation SEO pour chaque article ?
                      <span class="hint-icon" data-tooltip="m√©tas, maillage, balisage" role="note" tabindex="0" aria-label="m√©tas, maillage, balisage">?</span>
                    </label>
                    <select id="param_blog_seo">
                      <option value="1">Oui, optimiser chaque article</option>
                      <option value="0">Non, sans optimisation d√©di√©e</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="field-subsection">
                <p class="field-subtitle">Import d'articles existants</p>
                <div class="grid" aria-label="Blog et import d'articles">
                  <div class="field">
                    <label for="param_import_articles">
                      Articles √† importer (refonte)
                      <span class="hint-icon" data-tooltip="uniquement si blog activ√©" role="note" tabindex="0" aria-label="uniquement si blog activ√©">?</span>
                    </label>
                    <input type="number" id="param_import_articles" min="0" step="1" value="0">
                  </div>

                  <div class="field">
                    <label for="param_import_batch_size">
                      Articles par batch d'import
                      <span class="hint-icon" data-tooltip="pour le calcul d√©gressif" role="note" tabindex="0" aria-label="pour le calcul d√©gressif">?</span>
                    </label>
                    <input type="number" id="param_import_batch_size" min="1" step="1" value="10">
                  </div>

                  <div class="field">
                    <label for="param_import_base_cost">
                      Co√ªt initial par batch (‚Ç¨)
                      <span class="hint-icon" data-tooltip="avant d√©gressivit√©" role="note" tabindex="0" aria-label="avant d√©gressivit√©">?</span>
                    </label>
                    <input type="number" id="param_import_base_cost" min="0" step="10" value="120">
                  </div>

                  <div class="field">
                    <label for="param_import_degressif">
                      Facteur d√©gressif par batch
                      <span class="hint-icon" data-tooltip="0.9 = -10% par batch suppl√©mentaire" role="note" tabindex="0" aria-label="0.9 = -10% par batch suppl√©mentaire">?</span>
                    </label>
                    <input type="number" id="param_import_degressif" min="0" max="1.5" step="0.05" value="0.9">
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üé®</span> Identit√© visuelle</h3>
                <p class="group-sub">Module logo, d√©clinaisons, charte et templates.</p>
              </div>
              <div class="field-subsection">
                <p class="field-subtitle">Logo & pistes cr√©atives</p>
                <div class="grid" aria-label="Param√®tres identit√© visuelle">
                  <div class="field">
                    <label for="param_opt_logo">
                      Inclure la cr√©ation / refonte de logo ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_opt_logo" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_logo_concepts">
                      Nb. de pistes logo √† pr√©senter
                      <span class="hint-icon" data-tooltip="impacte le volume de design" role="note" tabindex="0" aria-label="impacte le volume de design">?</span>
                    </label>
                    <input type="number" id="param_logo_concepts" min="0" step="1" value="2">
                  </div>

                  <div class="field">
                    <label for="param_logo_exports">
                      D√©clinaisons & exports (formats)
                      <span class="hint-icon" data-tooltip="logos secondaires, d√©clinaisons" role="note" tabindex="0" aria-label="logos secondaires, d√©clinaisons">?</span>
                    </label>
                    <input type="number" id="param_logo_exports" min="0" step="1" value="3">
                  </div>
                </div>
              </div>

              <div class="field-subsection">
                <p class="field-subtitle">Charte & templates</p>
                <div class="grid" aria-label="Charte graphique et kits">
                  <div class="field">
                    <label for="param_brand_guidelines">
                      Niveau de charte graphique
                      <span class="hint-icon" data-tooltip="impacte le temps de formalisation" role="note" tabindex="0" aria-label="impacte le temps de formalisation">?</span>
                    </label>
                    <select id="param_brand_guidelines">
                      <option value="0">Pas de charte d√©di√©e</option>
                      <option value="1" selected>Guide express (x1)</option>
                      <option value="1.6">Charte compl√®te (x1.6)</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="param_brand_templates">
                      Templates r√©seaux / papeterie
                      <span class="hint-icon" data-tooltip="0 = non pr√©vu" role="note" tabindex="0" aria-label="0 = non pr√©vu">?</span>
                    </label>
                    <input type="number" id="param_brand_templates" min="0" step="1" value="2">
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üß∞</span> Options & accompagnement</h3>
                <p class="group-sub">Services compl√©mentaires √† activer.</p>
              </div>
              <div class="field-subsection">
                <p class="field-subtitle">Transfert & accompagnement</p>
                <div class="grid" aria-label="Options et accompagnement">
                  <div class="field">
                    <label for="param_opt_formation">
                      Formation client ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_opt_formation" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_opt_hosting">
                      Fournir l'h√©bergement ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_opt_hosting" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_hosting_cost">
                      Co√ªt h√©bergement (‚Ç¨)
                      <span class="hint-icon" data-tooltip="Budget annuel ou refacturation" role="note" tabindex="0" aria-label="Budget annuel ou refacturation">?</span>
                    </label>
                    <input type="number" id="param_hosting_cost" min="0" step="10" value="180">
                  </div>

                  <div class="field">
                    <label for="param_opt_domain">
                      R√©server le nom de domaine ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_opt_domain" min="0" max="1" step="1" value="1">
                  </div>

                  <div class="field">
                    <label for="param_domain_cost">
                      Co√ªt nom de domaine (‚Ç¨)
                      <span class="hint-icon" data-tooltip="enregistrement ou renouvellement" role="note" tabindex="0" aria-label="enregistrement ou renouvellement">?</span>
                    </label>
                    <input type="number" id="param_domain_cost" min="0" step="5" value="25">
                  </div>
                </div>
              </div>

              <div class="field-subsection">
                <p class="field-subtitle">Exp√©riences avanc√©es</p>
                <div class="grid" aria-label="Options avanc√©es">
                  <div class="field">
                    <label for="param_opt_chatbot">
                      Activer un ChatBot IA ?
                      <span class="hint-icon" data-tooltip="0 = non, 1 = oui" role="note" tabindex="0" aria-label="0 = non, 1 = oui">?</span>
                    </label>
                    <input type="number" id="param_opt_chatbot" min="0" max="1" step="1" value="0">
                  </div>

                  <div class="field">
                    <label for="param_chatbot_hours">
                      Charge dev ChatBot (h)
                      <span class="hint-icon" data-tooltip="Personnalisation, int√©gration front et API" role="note" tabindex="0" aria-label="Personnalisation, int√©gration front et API">?</span>
                    </label>
                    <input type="number" id="param_chatbot_hours" min="0" step="1" value="8">
                  </div>

                  <div class="field">
                    <label for="param_chatbot_cost">
                      Co√ªt outil / tokens (‚Ç¨)
                      <span class="hint-icon" data-tooltip="Cr√©dits API, licence ou forfait" role="note" tabindex="0" aria-label="Cr√©dits API, licence ou forfait">?</span>
                    </label>
                    <input type="number" id="param_chatbot_cost" min="0" step="10" value="120">
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="group-header">
                <h3 class="group-title"><span class="icon">üí∞</span> Marges & taux</h3>
                <p class="group-sub">Adapter le prix final au contexte financier.</p>
              </div>
              <div class="grid" aria-label="Marge et taux de change">
                <div class="field">
                  <label for="param_margin">
                    Coefficient de marge agence
                    <span class="hint-icon" data-tooltip="ex : 1.3 = +30%" role="note" tabindex="0" aria-label="ex : 1.3 = +30%">?</span>
                  </label>
                  <input type="number" id="param_margin" min="1" step="0.05" value="1.3">
                </div>

                <div class="field">
                  <label for="param_fx">
                    Taux de change ‚Ç¨ ‚Üí MGA
                    <span class="hint-icon" data-tooltip="approximatif" role="note" tabindex="0" aria-label="approximatif">?</span>
                  </label>
                  <input type="number" id="param_fx" min="1" step="50" value="5000">
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- COLONNE 1 : R√¥les & tarifs -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üë•</span> R√¥les & tarifs</h2>
              <p class="sub">Ajuste les taux horaires freelance. Tous les co√ªts se recalculent.</p>
            </div>
            <div class="tag">
              <span class="tag-dot"></span>
              Taux horaires en ‚Ç¨/h
            </div>
          </div>

          <div class="roles-table-wrapper roles-table" aria-label="Table des r√¥les et taux horaires">
            <table>
              <thead>
                <tr>
                  <th>R√¥le</th>
                  <th>Taux horaire (‚Ç¨)</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="roles-body">
                <!-- lignes g√©n√©r√©es en JS -->
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-stack sticky-summary">
        <!-- COLONNE 2 : R√©sum√©s rapides -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üß≠</span> R√©sum√© rapide</h2>
              <p class="sub">Vue d'ensemble des volumes et options activ√©es.</p>
            </div>
          </div>
          <div class="section">
            <div class="section-header">
              <div class="chip-group">
                <span class="chip"><strong>Pages</strong> : home + internes</span>
                <span class="chip"><strong>Options</strong> : logo, formation, h√©bergement, SEO</span>
              </div>
            </div>
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Volume de pages</div>
                <div class="summary-value" id="summary-pages">‚Äî</div>
                <div class="summary-chip muted">Home + internes (services / blog inclus si activ√©s)</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Complexit√© appliqu√©e</div>
                <div class="summary-value accent" id="summary-complexity">x1.2</div>
                <div class="summary-chip">Simple / Standard / Complexe</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Options activ√©es</div>
                <div class="summary-value" id="summary-options">‚Äî</div>
                <div class="summary-chip muted">Identit√© visuelle, services/r√©as, blog, SEO, formation, h√©bergement, domaine, ChatBot</div>
              </div>
            </div>
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Pages l√©gales</div>
                <div class="summary-value" id="summary-legal-pages">‚Äî</div>
                <div class="summary-chip muted">Toujours compt√©es dans les internes</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Blog & import</div>
                <div class="summary-value" id="summary-import">‚Äî</div>
                <div class="summary-chip muted">Activation du blog + co√ªt d√©gressif</div>
              </div>
            </div>
          </div>
        </section>

        <!-- COLONNE 2 : R√©sum√© financier -->
        <section class="card">
          <div class="card-header">
            <div>
              <h2><span class="icon">üí∞</span> R√©sum√© financier</h2>
              <p class="sub">Synth√®se imm√©diate des montants g√©n√©r√©s par tes param√®tres.</p>
            </div>
          </div>
          <div class="section">
            <div class="summary-row">
              <div class="summary-card">
                <div class="summary-label">Freelances</div>
                <div class="summary-value" id="summary-cost-freelance">‚Äî</div>
                <div class="summary-chip muted">Total co√ªts avant buffer</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Co√ªt interne estim√©</div>
                <div class="summary-value" id="summary-cost-internal">‚Äî</div>
                <div class="summary-chip muted">Freelances + buffer impr√©vus</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Prix conseill√© HT (‚Ç¨)</div>
                <div class="summary-value success" id="summary-price-sell">‚Äî</div>
                <div class="summary-chip">Marge agence + buffer impr√©vus</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Prix conseill√© HT (MGA)</div>
                <div class="summary-value accent" id="summary-price-sell-mga">‚Äî</div>
                <div class="summary-chip muted">Conversion indicative en Ariary</div>
              </div>
            </div>
          </div>

          <p class="footer-note" id="filter-feedback" aria-live="polite">
            Le filtre par r√¥le mettra √† jour automatiquement les heures, les co√ªts et les prix conseill√©s selon la s√©lection.
          </p>
        </section>
      </div>
    </main>

    <!-- SECTION D√âTAIL DES T√ÇCHES -->
    <section class="section" style="margin-top: 26px;">
      <div class="card">
        <div class="section-header">
          <h3>D√©tail des t√¢ches & temps estim√©s</h3>
          <span class="muted">Les heures tiennent compte du volume, de la complexit√© et des options activ√©es.</span>
        </div>

        <div class="tasks-toolbar" aria-label="Filtrer les t√¢ches par r√¥le">
          <div class="toolbar-text">
            <label for="tasks-role-filter">Filtrer par r√¥le</label>
            <span class="label-sub">Affiche uniquement les t√¢ches li√©es au profil choisi.</span>
          </div>
          <div class="toolbar-actions">
            <label class="toggle" for="toggle-zero-cost">
              <input type="checkbox" id="toggle-zero-cost">
              <span class="toggle-switch" aria-hidden="true"></span>
              <span class="toggle-label" id="toggle-zero-cost-label">T√¢ches √† 0‚Ç¨ affich√©es</span>
            </label>
            <div class="filter-select">
              <span class="filter-icon" aria-hidden="true">üîç</span>
              <select id="tasks-role-filter"></select>
              <span class="select-caret" aria-hidden="true">‚ñæ</span>
            </div>
            <button type="button" id="export_tasks" class="ghost-button ghost-button--compact" aria-label="Exporter les t√¢ches visibles en CSV">üì§ Export CSV</button>
          </div>
        </div>

        <div class="tasks-table-wrapper" aria-label="D√©tail des t√¢ches et calculs">
          <table>
            <thead>
              <tr>
                <th>Phase</th>
                <th>T√¢che</th>
                <th>R√¥le</th>
                <th class="align-right">Base h</th>
                <th class="align-right">Volume</th>
                <th class="align-right">Heures totales</th>
                <th class="align-right">Taux ‚Ç¨/h</th>
                <th class="align-right">Co√ªt t√¢che (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody id="tasks-body">
              <!-- lignes g√©n√©r√©es en JS -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="align-right">Total heures</td>
                <td class="align-right" id="tfoot-hours">‚Äî</td>
                <td></td>
                <td class="align-right" id="tfoot-cost">‚Äî</td>
              </tr>
              <tr>
                <td colspan="7" class="align-right">Total co√ªts avant buffer</td>
                <td class="align-right" id="tfoot-prebuffer">‚Äî</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----- Donn√©es de base -----

    const roles = [
      {
        id: "cp",
        name: "Chef de projet / Relation client",
        rate: 30,
        note: "R√©unions, cadrage, suivi client",
        icon: "ü§ù"
      },
      {
        id: "ux",
        name: "Webdesigner / UX-UI",
        rate: 35,
        note: "Maquettes, UI, parcours utilisateur",
        icon: "üé®"
      },
      {
        id: "dev",
        name: "D√©veloppeur WordPress",
        rate: 40,
        note: "Int√©gration, th√®me, plugins",
        icon: "üíª"
      },
      {
        id: "graph",
        name: "Graphiste",
        rate: 28,
        note: "Logo, charte, visuels",
        icon: "üñºÔ∏è"
      },
      {
        id: "seo",
        name: "R√©dacteur / SEO",
        rate: 30,
        note: "Contenu & on-page SEO",
        icon: "üîé"
      },
      {
        id: "qa",
        name: "QA / Tests",
        rate: 25,
        note: "Recette, tests responsive",
        icon: "‚úÖ"
      }
    ];

    let activeRoleFilter = "all";
    let hideZeroCost = false;
    let lastTotals = {
      hours: 0,
      cost: 0,
      internal: 0,
      sell: 0
    };

    const roleIconStyles = {
      all: {
        icon: "üéöÔ∏è",
        color: "var(--accent)",
        bg: "var(--accent-soft)",
        border: "rgba(56, 189, 248, 0.35)"
      },
      cp: {
        icon: "ü§ù",
        color: "#fbbf24",
        bg: "rgba(251, 191, 36, 0.14)",
        border: "rgba(251, 191, 36, 0.3)"
      },
      ux: {
        icon: "üé®",
        color: "#a855f7",
        bg: "rgba(168, 85, 247, 0.18)",
        border: "rgba(168, 85, 247, 0.32)"
      },
      dev: {
        icon: "üíª",
        color: "#38bdf8",
        bg: "rgba(56, 189, 248, 0.14)",
        border: "rgba(56, 189, 248, 0.35)"
      },
      graph: {
        icon: "üñºÔ∏è",
        color: "#22d3ee",
        bg: "rgba(34, 211, 238, 0.16)",
        border: "rgba(34, 211, 238, 0.3)"
      },
      seo: {
        icon: "üîé",
        color: "#4ade80",
        bg: "rgba(74, 222, 128, 0.18)",
        border: "rgba(74, 222, 128, 0.35)"
      },
      qa: {
        icon: "‚úÖ",
        color: "#facc15",
        bg: "rgba(250, 204, 21, 0.12)",
        border: "rgba(250, 204, 21, 0.32)"
      }
    };

    const tasks = [
      // Cadrage
      {
        id: "atelier",
        phase: "Cadrage",
        label: "Atelier de d√©couverte & cadrage",
        roleId: "cp",
        baseHours: 3,
        volumeKey: "const"
      },
      {
        id: "cdc",
        phase: "Cadrage",
        label: "R√©daction cahier des charges",
        roleId: "cp",
        baseHours: 4,
        volumeKey: "const"
      },
      // Design
      {
        id: "design_home",
        phase: "Design",
        label: "Maquette page d'accueil",
        roleId: "ux",
        baseHours: 6,
        volumeKey: "nbHome"
      },
      {
        id: "design_internes",
        phase: "Design",
        label: "Maquettes pages internes",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "nbInternalPages"
      },
      {
        id: "design_services_listing",
        phase: "Design",
        label: "Maquette page Services",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "serviceListing"
      },
      {
        id: "design_services_details",
        phase: "Design",
        label: "Maquettes fiches service",
        roleId: "ux",
        baseHours: 2.5,
        volumeKey: "serviceDetailsWeighted"
      },
      {
        id: "design_realisations_listing",
        phase: "Design",
        label: "Maquette page R√©alisations",
        roleId: "ux",
        baseHours: 3,
        volumeKey: "reaListing"
      },
      {
        id: "design_realisations_details",
        phase: "Design",
        label: "Maquettes √©tudes de cas",
        roleId: "ux",
        baseHours: 2.5,
        volumeKey: "reaDetailsWeighted"
      },
      {
        id: "design_blog",
        phase: "Design",
        label: "Maquettes blog (listing + article)",
        roleId: "ux",
        baseHours: 4,
        volumeKey: "hasBlog"
      },
      // Graphisme
      {
        id: "logo_discovery",
        phase: "Graphisme",
        label: "Moodboard & orientation cr√©ative",
        roleId: "graph",
        baseHours: 2,
        volumeKey: "identityPack"
      },
      {
        id: "logo_concepts",
        phase: "Graphisme",
        label: "Pistes logo √† d√©velopper",
        roleId: "graph",
        baseHours: 2.8,
        volumeKey: "logoConcepts"
      },
      {
        id: "logo_exports",
        phase: "Graphisme",
        label: "D√©clinaisons & exports du logo",
        roleId: "graph",
        baseHours: 1,
        volumeKey: "logoExports"
      },
      {
        id: "brand_guidelines",
        phase: "Graphisme",
        label: "Mini charte graphique / brandbook",
        roleId: "graph",
        baseHours: 3.5,
        volumeKey: "brandGuidelines"
      },
      {
        id: "brand_templates",
        phase: "Graphisme",
        label: "Templates r√©seaux sociaux / papeterie",
        roleId: "graph",
        baseHours: 1.2,
        volumeKey: "brandTemplates"
      },
      // D√©veloppement
      {
        id: "dev_home",
        phase: "D√©veloppement",
        label: "Int√©gration page d'accueil",
        roleId: "dev",
        baseHours: 6,
        volumeKey: "nbHome"
      },
      {
        id: "dev_pages",
        phase: "D√©veloppement",
        label: "Int√©gration pages internes",
        roleId: "dev",
        baseHours: 3,
        volumeKey: "nbInternalPages"
      },
      {
        id: "dev_services_listing",
        phase: "D√©veloppement",
        label: "Int√©gration page Services",
        roleId: "dev",
        baseHours: 4,
        volumeKey: "serviceListing"
      },
      {
        id: "dev_services_details",
        phase: "D√©veloppement",
        label: "Int√©gration fiches service",
        roleId: "dev",
        baseHours: 3.5,
        volumeKey: "serviceDetailsWeighted"
      },
      {
        id: "dev_realisations_listing",
        phase: "D√©veloppement",
        label: "Int√©gration page R√©alisations",
        roleId: "dev",
        baseHours: 4,
        volumeKey: "reaListing"
      },
      {
        id: "dev_realisations_details",
        phase: "D√©veloppement",
        label: "Int√©gration √©tudes de cas",
        roleId: "dev",
        baseHours: 3.5,
        volumeKey: "reaDetailsWeighted"
      },
      {
        id: "dev_blog",
        phase: "D√©veloppement",
        label: "Int√©gration blog (listing + article)",
        roleId: "dev",
        baseHours: 5,
        volumeKey: "hasBlog"
      },
      {
        id: "dev_import_articles",
        phase: "D√©veloppement",
        label: "Blog : importation d'articles (refonte)",
        roleId: "dev",
        baseHours: 0,
        volumeKey: "const",
        type: "import"
      },
      {
        id: "content_articles",
        phase: "Contenus",
        label: "Cr√©ation + mise en ligne des articles",
        roleId: "seo",
        baseHours: 2.5,
        volumeKey: "blogArticles"
      },
      {
        id: "content_services",
        phase: "Contenus",
        label: "R√©daction + optimisation fiches service",
        roleId: "seo",
        baseHours: 2.3,
        volumeKey: "serviceContentPages"
      },
      {
        id: "content_realisations",
        phase: "Contenus",
        label: "R√©daction + optimisation √©tudes de cas",
        roleId: "seo",
        baseHours: 2.6,
        volumeKey: "reaContentPages"
      },
      {
        id: "content_article_visuals",
        phase: "Contenus",
        label: "Visuel d'illustration par article",
        roleId: "graph",
        baseHours: 1,
        volumeKey: "articleVisuals"
      },
      {
        id: "content_service_visuals",
        phase: "Contenus",
        label: "Visuels pour fiches service",
        roleId: "graph",
        baseHours: 0.8,
        volumeKey: "serviceVisualsVolume"
      },
      {
        id: "content_rea_visuals",
        phase: "Contenus",
        label: "Visuels pour √©tudes de cas",
        roleId: "graph",
        baseHours: 1.2,
        volumeKey: "reaVisualsVolume"
      },
      {
        id: "dev_config",
        phase: "D√©veloppement",
        label: "Configuration WordPress & plugins",
        roleId: "dev",
        baseHours: 3,
        volumeKey: "const"
      },
      // Options & services additionnels
      {
        id: "hosting",
        phase: "Options",
        label: "H√©bergement / infog√©rance",
        roleId: "cp",
        baseHours: 0,
        volumeKey: "optHosting",
        type: "fixed",
        costKey: "hostingCost"
      },
      {
        id: "domain",
        phase: "Options",
        label: "Nom de domaine",
        roleId: "cp",
        baseHours: 0,
        volumeKey: "optDomain",
        type: "fixed",
        costKey: "domainCost"
      },
      {
        id: "chatbot_setup",
        phase: "D√©veloppement",
        label: "Int√©gration / orchestration ChatBot IA",
        roleId: "dev",
        baseHours: 0,
        volumeKey: "optChatbot",
        type: "custom-hours",
        hoursKey: "chatbotHours",
        applyComplexity: false
      },
      {
        id: "chatbot_budget",
        phase: "Options",
        label: "Budget solution ChatBot (API / licence)",
        roleId: "cp",
        baseHours: 0,
        volumeKey: "optChatbot",
        type: "fixed",
        costKey: "chatbotBudget"
      },
      // SEO
      {
        id: "seo_articles",
        phase: "SEO",
        label: "Optimisation SEO des articles",
        roleId: "seo",
        baseHours: 1,
        volumeKey: "articleSeo"
      },
      {
        id: "seo_pages",
        phase: "SEO",
        label: "Optimisation SEO on-page",
        roleId: "seo",
        baseHours: 1.5,
        volumeKey: "nbSeoPages"
      },
      // Recette
      {
        id: "tests",
        phase: "Recette",
        label: "Tests responsive & bugfix",
        roleId: "qa",
        baseHours: 4,
        volumeKey: "const"
      },
      // Formation
      {
        id: "formation",
        phase: "Formation",
        label: "Session de formation client",
        roleId: "cp",
        baseHours: 2,
        volumeKey: "optFormation"
      }
    ];

    const rolesById = {};
    roles.forEach(r => rolesById[r.id] = r);

    const SITE_PRESETS = {
      landing: {
        label: "Landing Page",
        values: {
          param_nb_home: 1,
          param_nb_pages: 1,
          param_nb_legal: 2,
          param_nb_seo: 2,
          param_seo_mode: 1,
          param_service_listing: 0,
          param_service_details: 0,
          param_service_design_mode: 1,
          param_service_content: 1,
          param_service_visuals: 0,
          param_rea_listing: 0,
          param_rea_details: 0,
          param_rea_design_mode: 1,
          param_rea_content: 1,
          param_rea_visuals: 0,
          param_has_blog: 0,
          param_blog_articles: 0,
          param_blog_visuals: 1,
          param_blog_seo: 1,
          param_opt_logo: 0,
          param_logo_concepts: 0,
          param_logo_exports: 0,
          param_brand_guidelines: 0,
          param_brand_templates: 0,
          param_opt_formation: 0,
          param_opt_hosting: 1,
          param_hosting_cost: 180,
          param_opt_domain: 1,
          param_domain_cost: 25,
          param_opt_chatbot: 0,
          param_chatbot_hours: 8,
          param_chatbot_cost: 120,
          param_complexity: 1,
          param_margin: 1.3,
          param_fx: 5000,
          param_buffer: 10,
          param_import_articles: 0,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      },
      vitrine: {
        label: "Site vitrine",
        values: {
          param_nb_home: 1,
          param_nb_pages: 4,
          param_nb_legal: 3,
          param_nb_seo: 5,
          param_seo_mode: 1,
          param_service_listing: 1,
          param_service_details: 3,
          param_service_design_mode: 1,
          param_service_content: 1,
          param_service_visuals: 0,
          param_rea_listing: 1,
          param_rea_details: 3,
          param_rea_design_mode: 1,
          param_rea_content: 1,
          param_rea_visuals: 0,
          param_has_blog: 1,
          param_blog_articles: 2,
          param_blog_visuals: 1,
          param_blog_seo: 1,
          param_opt_logo: 0,
          param_logo_concepts: 2,
          param_logo_exports: 3,
          param_brand_guidelines: 1,
          param_brand_templates: 2,
          param_opt_formation: 0,
          param_opt_hosting: 1,
          param_hosting_cost: 180,
          param_opt_domain: 1,
          param_domain_cost: 25,
          param_opt_chatbot: 0,
          param_chatbot_hours: 8,
          param_chatbot_cost: 120,
          param_complexity: 1.2,
          param_margin: 1.3,
          param_fx: 5000,
          param_buffer: 10,
          param_import_articles: 0,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      },
      vitrine_avancee: {
        label: "Vitrine avanc√©e",
        values: {
          param_nb_home: 1,
          param_nb_pages: 8,
          param_nb_legal: 3,
          param_nb_seo: 12,
          param_seo_mode: 1.3,
          param_service_listing: 1,
          param_service_details: 6,
          param_service_design_mode: 1.4,
          param_service_content: 1,
          param_service_visuals: 1,
          param_rea_listing: 1,
          param_rea_details: 6,
          param_rea_design_mode: 1.4,
          param_rea_content: 1,
          param_rea_visuals: 1,
          param_has_blog: 1,
          param_blog_articles: 6,
          param_blog_visuals: 1,
          param_blog_seo: 1,
          param_opt_logo: 1,
          param_logo_concepts: 3,
          param_logo_exports: 4,
          param_brand_guidelines: 1.6,
          param_brand_templates: 3,
          param_opt_formation: 1,
          param_opt_hosting: 1,
          param_hosting_cost: 220,
          param_opt_domain: 1,
          param_domain_cost: 30,
          param_opt_chatbot: 0,
          param_chatbot_hours: 12,
          param_chatbot_cost: 180,
          param_complexity: 1.5,
          param_margin: 1.35,
          param_fx: 5000,
          param_buffer: 12,
          param_import_articles: 15,
          param_import_batch_size: 10,
          param_import_base_cost: 120,
          param_import_degressif: 0.9
        }
      }
    };

    // ----- Helpers -----

    function safeNumber(value, fallback = 0) {
      const n = Number(value);
      if (Number.isNaN(n)) return fallback;
      return n;
    }

    function fmtEuro(num, digits = 0) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      }) + " ‚Ç¨";
    }

    function fmtMGA(num) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }) + " MGA";
    }

    function fmtHours(num) {
      if (!Number.isFinite(num)) return "‚Äî";
      return num.toLocaleString("fr-FR", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      });
    }

    function applyPreset(key) {
      const preset = SITE_PRESETS[key];
      if (!preset) return;

      Object.entries(preset.values).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = value;
      });

      recalcAll();
    }

    const PARAM_INPUT_IDS = [
      "param_complexity",
      "param_nb_home",
      "param_nb_pages",
      "param_nb_legal",
      "param_nb_seo",
      "param_seo_mode",
      "param_service_listing",
      "param_service_details",
      "param_service_design_mode",
      "param_service_content",
      "param_service_visuals",
      "param_rea_listing",
      "param_rea_details",
      "param_rea_design_mode",
      "param_rea_content",
      "param_rea_visuals",
      "param_has_blog",
      "param_blog_articles",
      "param_blog_visuals",
      "param_blog_seo",
      "param_opt_logo",
      "param_logo_concepts",
      "param_logo_exports",
      "param_brand_guidelines",
      "param_brand_templates",
      "param_opt_formation",
      "param_opt_hosting",
      "param_hosting_cost",
      "param_opt_domain",
      "param_domain_cost",
      "param_opt_chatbot",
      "param_chatbot_hours",
      "param_chatbot_cost",
      "param_margin",
      "param_fx",
      "param_buffer",
      "param_import_articles",
      "param_import_batch_size",
      "param_import_base_cost",
      "param_import_degressif"
    ];

    const ALL_INPUT_IDS = [...PARAM_INPUT_IDS, "param_type_site", "param_comment"];

    function readParams() {
      const nbHome = Math.max(1, safeNumber(document.getElementById("param_nb_home").value, 1));
      const nbPages = Math.max(0, safeNumber(document.getElementById("param_nb_pages").value, 0));
      const nbLegal = Math.max(0, safeNumber(document.getElementById("param_nb_legal").value, 0));
      const seoIntensity = Math.max(0, safeNumber(document.getElementById("param_seo_mode").value, 1));
      const baseSeoFocus = Math.max(0, safeNumber(document.getElementById("param_nb_seo").value, 0));
      const nbServiceListing = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_service_listing").value, 1)));
      const nbServiceDetails = Math.max(0, safeNumber(document.getElementById("param_service_details").value, 0));
      const serviceDesignFactor = safeNumber(document.getElementById("param_service_design_mode").value, 1);
      const serviceContentMode = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_service_content").value, 1)));
      const serviceVisualsPref = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_service_visuals").value, 0)));
      const nbReaListing = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_rea_listing").value, 1)));
      const nbReaDetails = Math.max(0, safeNumber(document.getElementById("param_rea_details").value, 0));
      const reaDesignFactor = safeNumber(document.getElementById("param_rea_design_mode").value, 1);
      const reaContentMode = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_rea_content").value, 1)));
      const reaVisualsPref = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_rea_visuals").value, 0)));
      const hasBlog = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_has_blog").value, 1)));
      const blogArticlesRaw = Math.max(0, safeNumber(document.getElementById("param_blog_articles").value, 0));
      const blogArticles = hasBlog ? blogArticlesRaw : 0;
      const wantsBlogVisuals = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_blog_visuals").value, 1)));
      const wantsBlogSeo = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_blog_seo").value, 1)));
      const articleVisualsVolume = blogArticles * wantsBlogVisuals;
      const articleSeoVolume = blogArticles * wantsBlogSeo;
      const optLogo = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_logo").value, 0)));
      const logoConceptsRaw = Math.max(0, safeNumber(document.getElementById("param_logo_concepts").value, 2));
      const logoConcepts = optLogo ? logoConceptsRaw : 0;
      const logoExportsRaw = Math.max(0, safeNumber(document.getElementById("param_logo_exports").value, 3));
      const logoExports = optLogo ? logoExportsRaw : 0;
      const brandGuidelinesMode = optLogo ? Math.max(0, safeNumber(document.getElementById("param_brand_guidelines").value, 1)) : 0;
      const brandTemplatesRaw = Math.max(0, safeNumber(document.getElementById("param_brand_templates").value, 2));
      const brandTemplates = optLogo ? brandTemplatesRaw : 0;
      const optFormation = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_formation").value, 0)));
      const optHosting = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_hosting").value, 0)));
      const hostingCostRaw = Math.max(0, safeNumber(document.getElementById("param_hosting_cost").value, 0));
      const hostingCost = optHosting ? hostingCostRaw : 0;
      const optDomain = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_domain").value, 0)));
      const domainCostRaw = Math.max(0, safeNumber(document.getElementById("param_domain_cost").value, 0));
      const domainCost = optDomain ? domainCostRaw : 0;
      const optChatbot = Math.max(0, Math.min(1, safeNumber(document.getElementById("param_opt_chatbot").value, 0)));
      const chatbotHoursRaw = Math.max(0, safeNumber(document.getElementById("param_chatbot_hours").value, 0));
      const chatbotHours = optChatbot ? chatbotHoursRaw : 0;
      const chatbotBudgetRaw = Math.max(0, safeNumber(document.getElementById("param_chatbot_cost").value, 0));
      const chatbotBudget = optChatbot ? chatbotBudgetRaw : 0;
      const complexity = safeNumber(document.getElementById("param_complexity").value, 1);
      const margin = Math.max(1, safeNumber(document.getElementById("param_margin").value, 1.3));
      const fx = Math.max(1, safeNumber(document.getElementById("param_fx").value, 5000));
      const bufferPercent = Math.max(0, safeNumber(document.getElementById("param_buffer").value, 0));
      const importArticlesRaw = Math.max(0, safeNumber(document.getElementById("param_import_articles").value, 0));
      const importArticles = hasBlog ? importArticlesRaw : 0;
      const importBatchSize = Math.max(1, safeNumber(document.getElementById("param_import_batch_size").value, 1));
      const importBaseCost = Math.max(0, safeNumber(document.getElementById("param_import_base_cost").value, 0));
      const importDegressive = Math.max(0, safeNumber(document.getElementById("param_import_degressif").value, 1));

      const totalInternalPages = nbPages + nbLegal;
      const totalPagesWithExtras = totalInternalPages + nbServiceListing + nbServiceDetails + nbReaListing + nbReaDetails + (hasBlog ? 2 : 0);
      const seoAutoPages = Math.round((nbHome + totalInternalPages) * seoIntensity);
      const serviceContentPages = serviceContentMode ? nbServiceListing + nbServiceDetails : 0;
      const reaContentPages = reaContentMode ? nbReaListing + nbReaDetails : 0;
      const serviceVisualsVolume = serviceContentMode ? serviceVisualsPref * nbServiceDetails : 0;
      const reaVisualsVolume = reaContentMode ? reaVisualsPref * nbReaDetails : 0;
      const nbSeoPages = seoAutoPages + baseSeoFocus + serviceContentPages + reaContentPages;

      return {
        nbHome,
        nbPages,
        nbLegal,
        totalInternalPages,
        totalPagesWithExtras,
        nbSeoPages,
        seoAutoPages,
        baseSeoFocus,
        nbServiceListing,
        nbServiceDetails,
        serviceDesignFactor,
        serviceContentMode,
        serviceContentPages,
        serviceVisualsVolume,
        nbReaListing,
        nbReaDetails,
        reaDesignFactor,
        reaContentMode,
        reaContentPages,
        reaVisualsVolume,
        hasBlog,
        blogArticles,
        articleVisualsVolume,
        articleSeoVolume,
        optLogo,
        logoConcepts,
        logoExports,
        brandGuidelinesMode,
        brandTemplates,
        optFormation,
        optHosting,
        hostingCost,
        optDomain,
        domainCost,
        optChatbot,
        chatbotHours,
        chatbotBudget,
        complexity,
        margin,
        fx,
        bufferPercent,
        importArticles,
        importBatchSize,
        importBaseCost,
        importDegressive
      };
    }

    function computeImportCost(importArticles, batchSize, baseCost, degressive) {
      if (importArticles <= 0 || batchSize <= 0 || baseCost <= 0) {
        return { cost: 0, batches: 0 };
      }

      const batches = Math.ceil(importArticles / batchSize);
      let cost = 0;

      for (let i = 0; i < batches; i++) {
        cost += baseCost * Math.pow(degressive, i);
      }

      return { cost, batches };
    }

    function getTaskVolume(task, params) {
      switch (task.volumeKey) {
        case "nbHome": return params.nbHome;
        case "nbInternalPages": return params.totalInternalPages;
        case "nbSeoPages": return params.nbSeoPages;
        case "identityPack": return params.optLogo;
        case "logoConcepts": return params.logoConcepts;
        case "logoExports": return params.logoExports;
        case "brandGuidelines": return params.brandGuidelinesMode;
        case "brandTemplates": return params.brandTemplates;
        case "optFormation": return params.optFormation;
        case "optHosting": return params.optHosting;
        case "optDomain": return params.optDomain;
        case "optChatbot": return params.optChatbot;
        case "chatbotHours": return params.chatbotHours;
        case "serviceListing": return params.nbServiceListing;
        case "serviceDetailsWeighted": return params.nbServiceDetails * params.serviceDesignFactor;
        case "serviceContentPages": return params.serviceContentPages;
        case "serviceVisualsVolume": return params.serviceVisualsVolume;
        case "reaListing": return params.nbReaListing;
        case "reaDetailsWeighted": return params.nbReaDetails * params.reaDesignFactor;
        case "reaContentPages": return params.reaContentPages;
        case "reaVisualsVolume": return params.reaVisualsVolume;
        case "blogArticles": return params.blogArticles;
        case "articleVisuals": return params.articleVisualsVolume;
        case "articleSeo": return params.articleSeoVolume;
        case "hasBlog": return params.hasBlog;
        case "const":
        default:
          return 1;
      }
    }

    // ----- Initialisation UI -----

    function initRolesTable() {
      const tbody = document.getElementById("roles-body");
      tbody.innerHTML = "";
      roles.forEach(role => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = role.name;

        const tdRate = document.createElement("td");
        tdRate.className = "align-right";
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = role.rate;
        input.dataset.roleId = role.id;
        input.addEventListener("input", () => {
          role.rate = safeNumber(input.value, role.rate);
          recalcAll();
        });
        tdRate.appendChild(input);

        const tdNote = document.createElement("td");
        tdNote.textContent = role.note;

        tr.appendChild(tdName);
        tr.appendChild(tdRate);
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      });
    }

    function applyFilterIcon(roleId) {
      const iconEl = document.querySelector(".filter-select .filter-icon");
      if (!iconEl) return;

      const style = roleIconStyles[roleId] || roleIconStyles.all;
      iconEl.textContent = style.icon;
      iconEl.style.color = style.color;
      iconEl.style.background = style.bg;
      iconEl.style.borderColor = style.border;
    }

    function totalsChanged(prev, next) {
      if (!prev || !next) return false;
      return ["hours", "cost", "internal", "sell"].some(key => {
        return Math.round((prev[key] ?? 0) * 100) !== Math.round((next[key] ?? 0) * 100);
      });
    }

    function updateFilterFeedback(roleId, hasChanged) {
      const feedback = document.getElementById("filter-feedback");
      if (!feedback) return;

      const defaultMessage = "Utilises le filtre par r√¥le pour voir le r√©sum√© financier du profil s√©lectionn√©.";
      const roleLabel = rolesById[roleId]?.name ?? roleId;

      if (roleId === "all") {
        feedback.textContent = defaultMessage;
        return;
      }

      feedback.innerHTML = `Filtre par r√¥le <b>${roleLabel}</b> appliqu√©`;
    }

    function updateZeroToggleLabel(checked) {
      const label = document.getElementById("toggle-zero-cost-label");
      if (!label) return;
      label.textContent = checked ? "T√¢ches √† 0‚Ç¨ masqu√©es" : "T√¢ches √† 0‚Ç¨ affich√©es";
    }

    function initZeroCostToggle() {
      const toggle = document.getElementById("toggle-zero-cost");
      if (!toggle) return;

      updateZeroToggleLabel(toggle.checked);

      toggle.addEventListener("change", () => {
        hideZeroCost = toggle.checked;
        updateZeroToggleLabel(toggle.checked);
        recalcAll();
      });
    }

    function initRoleFilter() {
      const select = document.getElementById("tasks-role-filter");
      if (!select) return;

      select.innerHTML = "";

      const optionAll = document.createElement("option");
      optionAll.value = "all";
      optionAll.textContent = "Tous les r√¥les";
      optionAll.dataset.icon = roleIconStyles.all.icon;
      select.appendChild(optionAll);

      roles.forEach(role => {
        const option = document.createElement("option");
        option.value = role.id;
        option.textContent = role.name;
        option.dataset.icon = role.icon || roleIconStyles.all.icon;
        select.appendChild(option);
      });

      select.value = activeRoleFilter;
      applyFilterIcon(select.value);

      select.addEventListener("change", () => {
        const previousTotals = { ...lastTotals };
        activeRoleFilter = select.value;
        applyFilterIcon(activeRoleFilter);
        const newTotals = recalcAll();
        updateFilterFeedback(activeRoleFilter, totalsChanged(previousTotals, newTotals));
      });
    }

    function initTasksTable() {
      const tbody = document.getElementById("tasks-body");
      tbody.innerHTML = "";
      tasks.forEach(task => {
        const tr = document.createElement("tr");
        tr.dataset.taskId = task.id;
        tr.dataset.roleId = task.roleId;

        const tdPhase = document.createElement("td");
        tdPhase.innerHTML = `<span class="tasks-phase">${task.phase}</span>`;

        const tdLabel = document.createElement("td");
        tdLabel.textContent = task.label;

        const tdRole = document.createElement("td");
        tdRole.textContent = rolesById[task.roleId]?.name || "‚Äî";

        const tdBase = document.createElement("td");
        tdBase.className = "align-right";
        tdBase.dataset.type = "base";
        tdBase.textContent = fmtHours(task.baseHours);

        const tdVolume = document.createElement("td");
        tdVolume.className = "align-right";
        tdVolume.textContent = "‚Äî";
        tdVolume.dataset.type = "volume";

        const tdHours = document.createElement("td");
        tdHours.className = "align-right";
        tdHours.textContent = "‚Äî";
        tdHours.dataset.type = "hours";

        const tdRate = document.createElement("td");
        tdRate.className = "align-right";
        tdRate.textContent = "‚Äî";
        tdRate.dataset.type = "rate";

        const tdCost = document.createElement("td");
        tdCost.className = "align-right";
        tdCost.textContent = "‚Äî";
        tdCost.dataset.type = "cost";

        tr.appendChild(tdPhase);
        tr.appendChild(tdLabel);
        tr.appendChild(tdRole);
        tr.appendChild(tdBase);
        tr.appendChild(tdVolume);
        tr.appendChild(tdHours);
        tr.appendChild(tdRate);
        tr.appendChild(tdCost);

        tbody.appendChild(tr);
      });
    }

    // ----- Recalcul global -----

    function recalcAll() {
      const params = readParams();
      const importResult = computeImportCost(
        params.importArticles,
        params.importBatchSize,
        params.importBaseCost,
        params.importDegressive
      );

      // R√©sum√© simple
      document.getElementById("summary-pages").textContent =
        `${params.nbHome} home ¬∑ ${params.totalPagesWithExtras} internes`;
      document.getElementById("summary-complexity").textContent =
        `x${params.complexity.toLocaleString("fr-FR", { minimumFractionDigits: 1, maximumFractionDigits: 1 })}`;
      document.getElementById("summary-legal-pages").textContent =
        params.nbLegal > 0
          ? `${params.nbLegal} pages l√©gales incluses`
          : "Aucune page l√©gale";
      const opts = [];
      if (params.optLogo === 1) opts.push("Logo");
      if (params.optFormation === 1) opts.push("Formation");
      if (params.optHosting === 1) opts.push(`H√©bergement ${fmtEuro(params.hostingCost, 0)}`);
      if (params.optDomain === 1) opts.push(`Nom de domaine ${fmtEuro(params.domainCost, 0)}`);
      if (params.optChatbot === 1) {
        const chatbotParts = [];
        if (params.chatbotHours > 0) chatbotParts.push(`${params.chatbotHours}h dev`);
        if (params.chatbotBudget > 0) chatbotParts.push(fmtEuro(params.chatbotBudget, 0));
        const chatbotLabel = chatbotParts.length ? ` (${chatbotParts.join(" + ")})` : "";
        opts.push(`ChatBot IA${chatbotLabel}`);
      }
      if (params.hasBlog === 1) opts.push("Blog");
      if (params.nbServiceListing === 1 || params.nbServiceDetails > 0) {
        const detailLabel = params.nbServiceDetails > 0 ? `${params.nbServiceDetails} fiches` : "listing seul";
        const designLabel = params.serviceDesignFactor > 1 ? "design d√©di√©" : "gabarit unique";
        opts.push(`Services ${detailLabel} (${designLabel})`);
      }
      if (params.serviceContentMode === 1 && params.serviceContentPages > 0) {
        opts.push(`R√©dac/SEO services x${params.serviceContentPages}`);
      }
      if (params.serviceVisualsVolume > 0) {
        opts.push(`Visuels services x${params.serviceVisualsVolume}`);
      }
      if (params.nbReaListing === 1 || params.nbReaDetails > 0) {
        const detailLabel = params.nbReaDetails > 0 ? `${params.nbReaDetails} cas` : "listing seul";
        const designLabel = params.reaDesignFactor > 1 ? "design d√©di√©" : "gabarit unique";
        opts.push(`R√©alisations ${detailLabel} (${designLabel})`);
      }
      if (params.reaContentMode === 1 && params.reaContentPages > 0) {
        opts.push(`R√©dac/SEO r√©as x${params.reaContentPages}`);
      }
      if (params.reaVisualsVolume > 0) {
        opts.push(`Visuels r√©as x${params.reaVisualsVolume}`);
      }
      if (params.nbSeoPages > 0) {
        const seoParts = [];
        if (params.seoAutoPages > 0) seoParts.push(`auto ${params.seoAutoPages}`);
        if (params.baseSeoFocus > 0) seoParts.push(`focus ${params.baseSeoFocus}`);
        if (params.serviceContentPages > 0) seoParts.push(`services ${params.serviceContentPages}`);
        if (params.reaContentPages > 0) seoParts.push(`r√©as ${params.reaContentPages}`);
        const seoBreakdown = seoParts.length ? ` (${seoParts.join(" / ")})` : "";
        opts.push(`SEO x${params.nbSeoPages}${seoBreakdown}`);
      }
      if (importResult.batches > 0) opts.push(`Import ${params.importArticles} art.`);
      document.getElementById("summary-options").textContent =
        opts.length ? opts.join(" ¬∑ ") : "Aucune option";
      document.getElementById("summary-import").textContent =
        params.hasBlog === 0
          ? "Blog non pr√©vu"
          : importResult.batches > 0
            ? `Blog activ√© ¬∑ ${params.importArticles} art. / ${importResult.batches} batchs ‚Üí ${fmtEuro(importResult.cost, 0)}`
            : "Blog activ√© ¬∑ pas d'import";

      // D√©tail des t√¢ches
      const tbody = document.getElementById("tasks-body");
      let totalHours = 0;
      let totalCost = 0;

      tasks.forEach(task => {
        const row = tbody.querySelector(`tr[data-task-id="${task.id}"]`);
        if (!row) return;

        const rate = rolesById[task.roleId]?.rate ?? 0;
        const isImportTask = task.type === "import";
        const matchesFilter = activeRoleFilter === "all" || task.roleId === activeRoleFilter;

        let baseHours = task.baseHours;
        let volume = getTaskVolume(task, params);
        let hours = task.baseHours * volume * params.complexity;
        let cost = hours * rate;

        if (task.type === "fixed") {
          baseHours = 0;
          hours = 0;
          cost = volume > 0 ? (params[task.costKey] ?? 0) : 0;
        } else if (task.type === "custom-hours") {
          const customHours = (params[task.hoursKey] ?? task.baseHours) * volume;
          baseHours = params[task.hoursKey] ?? task.baseHours;
          const shouldApplyComplexity = task.applyComplexity !== false;
          hours = shouldApplyComplexity ? customHours * params.complexity : customHours;
          cost = hours * rate;
        }

        if (isImportTask) {
          volume = params.importArticles;
          baseHours = rate > 0 ? params.importBaseCost / rate : 0;
          hours = rate > 0 ? importResult.cost / rate : 0;
          cost = importResult.cost;
        }

        if (matchesFilter) {
          totalHours += hours;
          totalCost += cost;
        }

        const isZeroCost = Math.abs(cost) < 0.0001;
        const isVisible = matchesFilter && !(hideZeroCost && isZeroCost);

        row.classList.toggle("is-hidden", !isVisible);
        row.querySelector('td[data-type="base"]').textContent = fmtHours(baseHours);
        row.querySelector('td[data-type="volume"]').textContent =
          volume.toLocaleString("fr-FR", { maximumFractionDigits: 1 });
        row.querySelector('td[data-type="hours"]').textContent = fmtHours(hours);
        row.querySelector('td[data-type="rate"]').textContent = fmtEuro(rate, 0);
        row.querySelector('td[data-type="cost"]').textContent = fmtEuro(cost, 0);
      });

      document.getElementById("tfoot-hours").textContent = fmtHours(totalHours);
      document.getElementById("tfoot-cost").textContent = fmtEuro(totalCost, 0);
      document.getElementById("tfoot-prebuffer").textContent = fmtEuro(totalCost, 0);

      // Buffer impr√©vus
      const bufferAmount = totalCost * (params.bufferPercent / 100);
      const internalWithBuffer = totalCost + bufferAmount;

      // Prix de vente
      const priceSell = internalWithBuffer * params.margin;
      const priceSellMGA = priceSell * params.fx;

      document.getElementById("summary-cost-freelance").textContent = fmtEuro(totalCost, 0);
      document.getElementById("summary-cost-internal").textContent = fmtEuro(internalWithBuffer, 0);
      document.getElementById("summary-price-sell").textContent = fmtEuro(priceSell, 0);
      document.getElementById("summary-price-sell-mga").textContent = fmtMGA(priceSellMGA);

      lastTotals = {
        hours: totalHours,
        cost: totalCost,
        internal: internalWithBuffer,
        sell: priceSell
      };

      return lastTotals;
    }

    function bindParamEvents() {
      PARAM_INPUT_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === "SELECT" ? "change" : "input";
        el.addEventListener(evt, recalcAll);
      });
    }

    function bindPresetControls() {
      const select = document.getElementById("param_type_site");
      const resetBtn = document.getElementById("preset_reset");

      if (select) {
        select.addEventListener("change", () => applyPreset(select.value));
      }

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          if (select) {
            applyPreset(select.value);
          }
        });
      }
    }

    function setImportStatus(message, isError = false) {
      const status = document.getElementById("import_status");
      if (!status) return;
      status.textContent = message;
      status.classList.toggle("error", Boolean(isError));
    }

    function serializeInputs() {
      const inputs = {};
      ALL_INPUT_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        inputs[id] = el.value;
      });
      return inputs;
    }

    function refreshRoleInputs() {
      document.querySelectorAll('#roles-body input[data-role-id]').forEach(input => {
        const role = rolesById[input.dataset.roleId];
        if (role) {
          input.value = role.rate;
        }
      });
    }

    function escapeCsvValue(value) {
      const normalized = String(value ?? "").replace(/\u00A0/g, " ").trim();
      return `"${normalized.replace(/"/g, '""')}"`;
    }

    function getVisibleTaskRows() {
      return Array.from(document.querySelectorAll("#tasks-body tr")).filter(row => !row.classList.contains("is-hidden"));
    }

    function exportTasksCsv() {
      const table = document.querySelector(".tasks-table-wrapper table");
      if (!table) return;

      const headerCells = Array.from(table.querySelectorAll("thead th")).map(cell => cell.textContent.trim());
      const visibleRows = getVisibleTaskRows();
      const rows = [];

      const filterLabel = activeRoleFilter === "all"
        ? "Tous les r√¥les"
        : (rolesById[activeRoleFilter]?.name ?? activeRoleFilter);

      rows.push(["Filtre par r√¥le", filterLabel]);
      rows.push(["T√¢ches visibles", String(visibleRows.length)]);
      rows.push([]);

      rows.push(headerCells);
      visibleRows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("td")).map(cell => cell.textContent.trim());
        rows.push(cells);
      });

      rows.push([]);
      const footerRows = Array.from(table.querySelectorAll("tfoot tr"));
      footerRows.forEach(tr => {
        const cells = Array.from(tr.querySelectorAll("td")).map(cell => cell.textContent.trim());
        rows.push(cells);
      });

      const csvContent = rows
        .map(columns => columns.map(escapeCsvValue).join(";"))
        .join("\n");

      const date = new Date();
      const stamp = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
      const projectSlug = slugifyComment(document.getElementById("param_comment")?.value || "devis");
      const filterSlug = slugifyComment(filterLabel);
      const filename = `${projectSlug}-taches-${filterSlug}-${stamp}.csv`;

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    function buildExportState() {
      return {
        meta: {
          exportedAt: new Date().toISOString()
        },
        inputs: serializeInputs(),
        roles: roles.map(role => ({ id: role.id, rate: role.rate }))
      };
    }

    function slugifyComment(comment) {
      const base = comment.trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
      return base || "calculateur-devis";
    }

    function exportParams() {
      const state = buildExportState();
      const comment = document.getElementById("param_comment")?.value || "";
      const date = new Date();
      const stamp = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
      const filename = `${slugifyComment(comment)}-${stamp}.json`;
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
      setImportStatus(`Export pr√™t (${filename})`);
    }

    function applyImportedState(data) {
      if (!data || typeof data !== "object") {
        throw new Error("Fichier invalide");
      }

      const inputs = data.inputs || {};
      ALL_INPUT_IDS.forEach(id => {
        if (!Object.prototype.hasOwnProperty.call(inputs, id)) return;
        const el = document.getElementById(id);
        if (el) {
          el.value = inputs[id];
        }
      });

      if (Array.isArray(data.roles)) {
        data.roles.forEach(r => {
          if (!r || typeof r !== "object") return;
          const role = rolesById[r.id];
          const rate = safeNumber(r.rate, role?.rate ?? 0);
          if (role) {
            role.rate = rate;
          }
        });
        refreshRoleInputs();
      }

      recalcAll();
      setImportStatus("Param√®tres import√©s avec succ√®s");
    }

    function handleImportFile(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          applyImportedState(data);
        } catch (err) {
          setImportStatus("Import impossible : fichier invalide", true);
        }
      };
      reader.onerror = () => setImportStatus("Import impossible : lecture √©chou√©e", true);
      reader.readAsText(file);

      // reset input value to allow re-importing the same file
      event.target.value = "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      initRolesTable();
      initRoleFilter();
      initZeroCostToggle();
      initTasksTable();
      bindPresetControls();
      bindParamEvents();
      document.getElementById("export_tasks")?.addEventListener("click", exportTasksCsv);
      document.getElementById("export_params")?.addEventListener("click", exportParams);
      document.getElementById("import_params")?.addEventListener("change", handleImportFile);
      const presetSelect = document.getElementById("param_type_site");
      const initialPreset = presetSelect?.value ?? "vitrine";
      applyPreset(initialPreset);
      updateFilterFeedback(activeRoleFilter, false);
    });
  </script>
</body>
</html>
